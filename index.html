<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amretha's AI Job Hunt Command Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fraunces:ital,wght@0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0d1b3e;
  --blue: #1a56db;
  --blue-light: #3b82f6;
  --blue-pale: #eff6ff;
  --blue-mid: #dbeafe;
  --accent: #0ea5e9;
  --accent2: #06b6d4;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --purple: #8b5cf6;
  --white: #ffffff;
  --gray-50: #f8fafc;
  --gray-100: #f1f5f9;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-400: #94a3b8;
  --gray-500: #64748b;
  --gray-600: #475569;
  --gray-700: #334155;
  --gray-800: #1e293b;
  --shadow: 0 4px 24px rgba(13,27,62,0.10);
  --shadow-lg: 0 8px 40px rgba(13,27,62,0.16);
  --radius: 14px;
  --radius-sm: 8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--gray-50);
  color: var(--gray-800);
  min-height: 100vh;
  font-size: 14px;
}

/* HEADER */
.app-header {
  background: linear-gradient(135deg, var(--navy) 0%, #1a3a6e 60%, #1a56db 100%);
  padding: 0 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px rgba(13,27,62,0.3);
}
.header-brand { display: flex; align-items: center; gap: 12px; }
.header-logo {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--accent), var(--blue-light));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 800; color: white;
  font-family: 'Fraunces', serif;
}
.header-title { color: white; font-size: 16px; font-weight: 700; }
.header-sub { color: rgba(255,255,255,0.6); font-size: 11px; margin-top: 1px; }

/* DAILY GOAL BAR */
.daily-goal-bar {
  background: linear-gradient(90deg, #1e3a8a, #1a56db);
  padding: 8px 28px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.goal-label { color: rgba(255,255,255,0.8); font-size: 12px; font-weight: 500; white-space: nowrap; }
.goal-progress-wrap { flex: 1; min-width: 150px; display: flex; align-items: center; gap: 10px; }
.goal-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.2); border-radius: 99px; overflow: hidden; }
.goal-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 99px; transition: width 0.5s ease; }
.goal-text { color: white; font-size: 12px; font-weight: 600; white-space: nowrap; }
.streak-badge { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); border-radius: 99px; padding: 3px 12px; color: white; font-size: 11px; font-weight: 600; white-space: nowrap; }
.goal-input-wrap { display: flex; align-items: center; gap: 6px; }
.goal-input-wrap label { color: rgba(255,255,255,0.7); font-size: 11px; }
.goal-num-input { width: 44px; padding: 3px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 12px; font-weight: 600; text-align: center; outline: none; }

/* TABS */
.tab-nav {
  background: var(--white);
  border-bottom: 2px solid var(--gray-100);
  display: flex;
  gap: 0;
  padding: 0 28px;
  overflow-x: auto;
  scrollbar-width: none;
}
.tab-nav::-webkit-scrollbar { display: none; }
.tab-btn {
  padding: 14px 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-500);
  white-space: nowrap;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 7px;
}
.tab-btn:hover { color: var(--blue); }
.tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
.tab-icon { font-size: 15px; }

/* MAIN CONTENT */
.tab-content { display: none; padding: 28px; max-width: 1400px; margin: 0 auto; }
.tab-content.active { display: block; }

/* CARDS & PANELS */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-100);
}
.card-title {
  font-family: 'Fraunces', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.section-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--gray-400);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 8px;
}

/* FORM ELEMENTS */
.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; }
.form-control {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 13px;
  color: var(--gray-800);
  background: var(--gray-50);
  transition: all 0.2s;
  outline: none;
}
.form-control:focus { border-color: var(--blue); background: white; box-shadow: 0 0 0 3px rgba(26,86,219,0.1); }
textarea.form-control { resize: vertical; min-height: 120px; line-height: 1.5; }
select.form-control { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; cursor: pointer; }

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-primary { background: linear-gradient(135deg, var(--blue), var(--accent)); color: white; box-shadow: 0 4px 12px rgba(26,86,219,0.3); }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(26,86,219,0.4); }
.btn-primary:active { transform: translateY(0); }
.btn-secondary { background: var(--blue-pale); color: var(--blue); border: 1.5px solid var(--blue-mid); }
.btn-secondary:hover { background: var(--blue-mid); }
.btn-success { background: linear-gradient(135deg, #059669, var(--success)); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.25); }
.btn-success:hover { transform: translateY(-1px); }
.btn-warning { background: linear-gradient(135deg, #d97706, var(--warning)); color: white; }
.btn-danger { background: linear-gradient(135deg, #dc2626, var(--danger)); color: white; }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-xs { padding: 4px 9px; font-size: 11px; border-radius: 6px; }
.btn-ghost { background: transparent; color: var(--gray-600); border: 1.5px solid var(--gray-200); }
.btn-ghost:hover { background: var(--gray-100); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }

/* OUTPUT AREAS */
.output-area {
  background: var(--gray-50);
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  padding: 16px;
  min-height: 80px;
  font-size: 13px;
  line-height: 1.7;
  color: var(--gray-700);
  white-space: pre-wrap;
  word-break: break-word;
}
.output-placeholder { color: var(--gray-400); font-style: italic; }

/* SCORE BADGE */
.score-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 99px;
  font-size: 13px;
  font-weight: 700;
}
.score-high { background: #dcfce7; color: #166534; }
.score-mid { background: #fef9c3; color: #854d0e; }
.score-low { background: #fee2e2; color: #991b1b; }

/* KEYWORD CHIPS */
.keyword-chip {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  margin: 3px;
}
.chip-found { background: #dcfce7; color: #166534; }
.chip-missing { background: #fee2e2; color: #991b1b; }

/* LOADING SPINNER */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2.5px solid rgba(255,255,255,0.4);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
.spinner-blue {
  border-color: rgba(26,86,219,0.2);
  border-top-color: var(--blue);
}
@keyframes spin { to { transform: rotate(360deg); } }

/* GRID LAYOUTS */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
.grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; }
.grid-half { display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px; }
.flex-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.flex-between { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }

/* STAT CARDS */
.stat-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-100);
  position: relative;
  overflow: hidden;
}
.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}
.stat-card.blue::before { background: linear-gradient(90deg, var(--blue), var(--accent)); }
.stat-card.green::before { background: linear-gradient(90deg, #059669, var(--success)); }
.stat-card.amber::before { background: linear-gradient(90deg, #d97706, var(--warning)); }
.stat-card.purple::before { background: linear-gradient(90deg, #7c3aed, var(--purple)); }
.stat-card.red::before { background: linear-gradient(90deg, #dc2626, var(--danger)); }
.stat-value { font-size: 28px; font-weight: 800; color: var(--navy); line-height: 1; margin: 4px 0; }
.stat-label { font-size: 11px; font-weight: 600; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.06em; }
.stat-icon { font-size: 28px; position: absolute; right: 16px; top: 14px; opacity: 0.15; }

/* ============ TAB 1 ‚Äî RESUME TAILORER ============ */
.t1-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 24px; }
.kw-section { margin-top: 16px; }
.kw-row { display: flex; align-items: flex-start; gap: 8px; flex-wrap: wrap; margin-top: 6px; }

/* ============ TAB 2 ‚Äî INTERVIEW PREP ============ */
.star-card {
  background: var(--blue-pale);
  border: 1.5px solid var(--blue-mid);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  margin-bottom: 12px;
}
.star-q { font-weight: 700; color: var(--navy); margin-bottom: 8px; font-size: 13px; }
.star-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-right: 4px; margin-bottom: 6px; }
.tag-s { background: #dbeafe; color: #1e40af; }
.tag-t { background: #dcfce7; color: #166534; }
.tag-a { background: #fef3c7; color: #92400e; }
.tag-r { background: #ede9fe; color: #5b21b6; }
.star-body { font-size: 12.5px; line-height: 1.6; color: var(--gray-700); }

/* ============ TAB 3 ‚Äî KANBAN ============ */
.tracker-layout { display: grid; grid-template-columns: 1fr 220px; gap: 20px; }
.kanban-board { overflow-x: auto; }
.kanban-columns { display: flex; gap: 12px; min-width: max-content; }
.kanban-col {
  width: 220px;
  flex-shrink: 0;
  background: var(--gray-100);
  border-radius: var(--radius);
  padding: 12px;
  min-height: 400px;
}
.kanban-col-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--gray-200);
}
.col-title { font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.05em; }
.col-count { background: var(--white); border-radius: 99px; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: var(--gray-600); }
.col-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

.job-card {
  background: var(--white);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(13,27,62,0.08);
  border: 1.5px solid var(--gray-100);
  cursor: grab;
  transition: all 0.2s;
  position: relative;
}
.job-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); border-color: var(--blue-mid); }
.job-card.dragging { opacity: 0.5; }
.job-card-company { font-weight: 700; font-size: 13px; color: var(--navy); }
.job-card-role { font-size: 12px; color: var(--gray-500); margin-top: 2px; }
.job-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
.meta-badge {
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 10px;
  font-weight: 700;
}
.badge-high { background: #fee2e2; color: #991b1b; }
.badge-medium { background: #fef9c3; color: #854d0e; }
.badge-low { background: #dcfce7; color: #166534; }
.badge-salary { background: var(--blue-pale); color: var(--blue); }
.badge-days { background: var(--gray-100); color: var(--gray-600); }
.badge-followup { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
.job-card-date { font-size: 10px; color: var(--gray-400); margin-top: 6px; }
.job-card-actions { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
.job-card-notes { font-size: 11px; color: var(--gray-500); margin-top: 6px; border-top: 1px solid var(--gray-100); padding-top: 6px; font-style: italic; }
.kanban-drop-zone { min-height: 40px; border: 2px dashed transparent; border-radius: 8px; transition: border-color 0.2s, background 0.2s; }
.kanban-drop-zone.drag-over { border-color: var(--blue); background: var(--blue-pale); }

/* FOLLOWUP SIDEBAR */
.followup-sidebar .card { padding: 16px; }
.followup-item { padding: 10px; background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; margin-bottom: 8px; }
.followup-company { font-weight: 700; font-size: 12px; color: var(--navy); }
.followup-role { font-size: 11px; color: var(--gray-500); }
.followup-days { font-size: 11px; font-weight: 700; color: #c2410c; margin-top: 3px; }

/* ANALYTICS */
.analytics-section { margin-top: 24px; }
.funnel-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.funnel-label { font-size: 12px; font-weight: 600; color: var(--gray-600); width: 100px; text-align: right; }
.funnel-track { flex: 1; height: 22px; background: var(--gray-100); border-radius: 99px; overflow: hidden; }
.funnel-fill { height: 100%; border-radius: 99px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; font-weight: 700; color: white; }
.chart-bars { display: flex; align-items: flex-end; gap: 6px; height: 80px; }
.chart-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
.chart-bar { width: 100%; background: linear-gradient(180deg, var(--blue-light), var(--blue)); border-radius: 4px 4px 0 0; min-height: 4px; }
.chart-bar-label { font-size: 10px; color: var(--gray-400); }

/* MODALS */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(13,27,62,0.5);
  backdrop-filter: blur(4px);
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal {
  background: white;
  border-radius: var(--radius);
  padding: 28px;
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  position: relative;
}
.modal-lg { max-width: 900px; }
.modal-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 20px; }
.modal-close {
  position: absolute; top: 16px; right: 16px;
  background: var(--gray-100); border: none; border-radius: 50%;
  width: 30px; height: 30px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center; color: var(--gray-500);
}
.modal-close:hover { background: var(--gray-200); }

/* CHECKLIST */
.checklist-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--gray-100); }
.checklist-item:last-child { border-bottom: none; }
.checklist-item input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--blue); cursor: pointer; }
.checklist-item label { font-size: 13px; color: var(--gray-700); cursor: pointer; }
.checklist-item.done label { text-decoration: line-through; color: var(--gray-400); }

/* TAB 4 ‚Äî AUTO APPLY / COMMAND CENTRE */
.company-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.company-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 99px;
  background: var(--blue-pale);
  border: 1.5px solid var(--blue-mid);
  color: var(--blue);
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
  cursor: pointer;
}
.company-chip:hover { background: var(--blue); color: white; border-color: var(--blue); }
.job-board-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-200);
  background: var(--white);
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  transition: all 0.2s;
  text-decoration: none;
}
.job-board-btn:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-pale); }
.boards-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap: 10px; margin-top: 12px; }
.three-panels { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.panel-box { border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); display: flex; flex-direction: column; }
.panel-header { padding: 12px 14px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); border-radius: var(--radius-sm) var(--radius-sm) 0 0; font-weight: 700; font-size: 13px; color: var(--navy); }
.panel-body { padding: 14px; flex: 1; font-size: 12px; line-height: 1.6; color: var(--gray-700); white-space: pre-wrap; }
.panel-footer { padding: 10px 14px; border-top: 1px solid var(--gray-200); display: flex; gap: 8px; }

/* TAB 5 ‚Äî SALARY & REFERRAL */
.salary-bar-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.salary-role { font-size: 12px; font-weight: 600; color: var(--gray-700); width: 170px; flex-shrink: 0; }
.salary-range-bar { flex: 1; height: 8px; background: var(--gray-100); border-radius: 99px; position: relative; }
.salary-fill { position: absolute; left: 0; top: 0; height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--blue), var(--accent)); }
.salary-numbers { font-size: 11px; color: var(--gray-500); white-space: nowrap; }
.target-marker { position: absolute; top: -4px; width: 3px; height: 16px; background: var(--danger); border-radius: 2px; }

.referral-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 10px; background: var(--gray-50); border-radius: var(--radius-sm); border: 1px solid var(--gray-200); margin-bottom: 8px; }
.referral-name { font-weight: 700; font-size: 13px; color: var(--navy); min-width: 100px; }
.referral-co { font-size: 12px; color: var(--gray-500); }

/* RESPONSIVE */
@media (max-width: 900px) {
  .t1-layout, .grid-2, .grid-3, .grid-4, .three-panels { grid-template-columns: 1fr; }
  .tracker-layout { grid-template-columns: 1fr; }
  .tab-content { padding: 16px; }
  .app-header { padding: 0 16px; }
}

/* TOAST */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--navy);
  color: white;
  padding: 12px 18px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease;
  max-width: 300px;
}
.toast.success { background: #064e3b; }
.toast.error { background: #7f1d1d; }
@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* DIVIDER */
.divider { height: 1px; background: var(--gray-200); margin: 20px 0; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--gray-100); }
::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 99px; }
::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }
</style>
</head>
<body>

<!-- HEADER -->


<div class="app-header">
  <div class="header-brand">
    <div class="header-logo">AK</div>
    <div>
      <div class="header-title">AI Job Hunt Command Centre</div>
      <div class="header-sub">Amretha Karthikeyan ¬∑ Lead BA ¬∑ Singapore ¬∑ Powered by Gemini AI ‚ú®</div>
    </div>
  </div>
  <div style="color:rgba(255,255,255,0.7);font-size:12px;" id="headerDate"></div>
</div>

<!-- DAILY GOAL BAR -->
<div class="daily-goal-bar">
  <div class="goal-label">üìÖ Daily Goal:</div>
  <div class="goal-input-wrap">
    <label>Target</label>
    <input type="number" class="goal-num-input" id="dailyGoalTarget" value="5" min="1" max="20" onchange="updateGoalDisplay()">
    <label>apps/day</label>
  </div>
  <div class="goal-progress-wrap">
    <div class="goal-bar-bg"><div class="goal-bar-fill" id="goalBarFill" style="width:0%"></div></div>
    <div class="goal-text" id="goalText">0 / 5 today</div>
  </div>
  <div class="streak-badge" id="streakBadge">üî• 0 day streak</div>
  <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);" onclick="incrementGoal()">+ Add App</button>
</div>

<!-- TABS -->
<div class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('tab1',this)"><span class="tab-icon">üìÑ</span>Resume Tailorer</button>
  <button class="tab-btn" onclick="switchTab('tab2',this)"><span class="tab-icon">üéØ</span>Interview Prep</button>
  <button class="tab-btn" onclick="switchTab('tab3',this)"><span class="tab-icon">üìã</span>Job Tracker</button>
  <button class="tab-btn" onclick="switchTab('tab4',this)"><span class="tab-icon">üöÄ</span>Auto-Apply Centre</button>
  <button class="tab-btn" onclick="switchTab('tab5',this)"><span class="tab-icon">üí∞</span>Salary & Referrals</button>
</div>

<!-- ========== TAB 1: RESUME TAILORER ========== -->
<div id="tab1" class="tab-content active">
  <div class="t1-layout">
    <div>
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">üìÑ Tailor My Resume</div>
        <div class="form-group">
          <label>Role Type</label>
          <select class="form-control" id="t1RoleType">
            <option value="Business Analyst">Business Analyst</option>
            <option value="Product Owner">Product Owner</option>
            <option value="Product Manager">Product Manager</option>
            <option value="AI Product Manager">AI Product Manager</option>
            <option value="AI Business Analyst">AI Business Analyst</option>
            <option value="Product Owner ‚Äì AI/ML">Product Owner ‚Äì AI/ML</option>
            <option value="Business Development">Business Development</option>
          </select>
        </div>
        <div class="form-group">
          <label>Paste Job Description *</label>
          <textarea class="form-control" id="t1JD" placeholder="Paste the full job description here..." style="min-height:200px;"></textarea>
        </div>
        <div class="flex-row">
          <button class="btn btn-primary" onclick="tailorResume()" id="tailorBtn">‚ú® Tailor My Resume</button>
          <button class="btn btn-secondary" onclick="generateCoverLetter()" id="coverBtn">üìù Generate Cover Letter</button>
        </div>
      </div>

      <div class="card" id="keywordCard" style="display:none;">
        <div class="card-title">üîë Keyword Analysis</div>
        <div class="flex-row" style="margin-bottom:12px;">
          <div>Score:</div>
          <div class="score-badge" id="kwScore">-</div>
        </div>
        <div class="kw-section">
          <div class="section-label">‚úÖ Keywords Found</div>
          <div class="kw-row" id="kwFound"></div>
        </div>
        <div class="kw-section" style="margin-top:14px;">
          <div class="section-label">‚ùå Keywords Missing</div>
          <div class="kw-row" id="kwMissing"></div>
        </div>
      </div>
    </div>

    <div>
      <div class="card" id="resumeOutputCard" style="margin-bottom:20px;">
        <div class="flex-between" style="margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0;">üìã Tailored Resume</div>
          <button class="btn btn-sm btn-secondary" onclick="downloadOutput('resumeOutput','tailored_resume.txt')" id="dlResumeBtn" style="display:none;">‚¨á Download</button>
        </div>
        <div class="output-area" id="resumeOutput">
          <span class="output-placeholder">Your ATS-optimised resume will appear here after clicking "Tailor My Resume"</span>
        </div>
      </div>
      <div class="card" id="coverOutputCard">
        <div class="flex-between" style="margin-bottom:14px;">
          <div class="card-title" style="margin-bottom:0;">‚úâÔ∏è Cover Letter</div>
          <button class="btn btn-sm btn-secondary" onclick="downloadOutput('coverOutput','cover_letter.txt')" id="dlCoverBtn" style="display:none;">‚¨á Download</button>
        </div>
        <div class="output-area" id="coverOutput">
          <span class="output-placeholder">Your cover letter will appear here after clicking "Generate Cover Letter"</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== TAB 2: INTERVIEW PREP ========== -->
<div id="tab2" class="tab-content">
  <div class="grid-half">
    <div class="card">
      <div class="card-title">üéØ Interview Prep Generator</div>
      <div class="form-group">
        <label>Company Name</label>
        <input type="text" class="form-control" id="t2Company" placeholder="e.g. Grab, GovTech, DBS...">
      </div>
      <div class="form-group">
        <label>Role Type</label>
        <select class="form-control" id="t2RoleType">
          <option value="Business Analyst">Business Analyst</option>
          <option value="Product Owner">Product Owner</option>
          <option value="Product Manager">Product Manager</option>
          <option value="Business Development">Business Development</option>
        </select>
      </div>
      <div class="form-group">
        <label>Job Description (optional but helps)</label>
        <textarea class="form-control" id="t2JD" placeholder="Paste JD for more tailored prep..." style="min-height:120px;"></textarea>
      </div>
      <button class="btn btn-primary" onclick="generateInterviewPrep()" id="prepBtn" style="width:100%;">üöÄ Prepare Me for Interview</button>
    </div>

    <div id="prepOutputArea">
      <div style="color:var(--gray-400);text-align:center;padding:60px 20px;">
        <div style="font-size:48px;margin-bottom:12px;">üéôÔ∏è</div>
        <div style="font-size:14px;">Fill in the details and generate your personalised interview prep kit</div>
      </div>
    </div>
  </div>
</div>

<!-- ========== TAB 3: JOB TRACKER ========== -->
<div id="tab3" class="tab-content">
  <!-- Dashboard Stats -->
  <div class="grid-4" style="margin-bottom:20px;" id="statsGrid">
    <div class="stat-card blue"><div class="stat-icon">üì®</div><div class="stat-label">Total Applications</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card green"><div class="stat-icon">üéôÔ∏è</div><div class="stat-label">Active Interviews</div><div class="stat-value" id="statInterviews">0</div></div>
    <div class="stat-card amber"><div class="stat-icon">üèÜ</div><div class="stat-label">Offers Received</div><div class="stat-value" id="statOffers">0</div></div>
    <div class="stat-card purple"><div class="stat-icon">üìà</div><div class="stat-label">Interview Rate %</div><div class="stat-value" id="statRate">0%</div></div>
  </div>

  <div class="flex-between" style="margin-bottom:16px;">
    <div class="card-title" style="margin-bottom:0;">üìã Application Kanban</div>
    <div class="flex-row">
      <button class="btn btn-primary btn-sm" onclick="openAddJobModal()">+ Add New Job</button>
      <button class="btn btn-sm" style="background:#f0fdf4;color:#15803d;border:1.5px solid #bbf7d0;" onclick="openImportModal()">üîó Import from URL</button>
      <button class="btn btn-sm" style="background:#faf5ff;color:#7c3aed;border:1.5px solid #ddd6fe;" onclick="openRankModal()">üèÜ AI Rank My Jobs</button>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">‚¨á Export CSV</button>
      <button class="btn btn-sm" style="background:#fff7ed;color:#c2410c;border:1.5px solid #fed7aa;" onclick="clearDemoData()">üóë Remove Demo Cards</button>
    </div>
  </div>

  <div class="tracker-layout">
    <div>
      <div class="kanban-board">
        <div class="kanban-columns" id="kanbanBoard"></div>
      </div>

      <!-- Analytics Section -->
      <div class="analytics-section">
        <div class="card" style="margin-top:20px;">
          <div class="card-title">üìä Application Analytics</div>
          <div class="grid-2">
            <div>
              <div class="section-label">Application Funnel</div>
              <div id="funnelChart" style="margin-top:10px;"></div>
            </div>
            <div>
              <div class="section-label">Weekly Applications</div>
              <div class="chart-bars" id="weeklyChart" style="margin-top:10px;"></div>
              <div style="font-size:11px;color:var(--gray-400);margin-top:6px;text-align:center;">Last 6 weeks</div>
              <div class="divider"></div>
              <div class="section-label">Source Breakdown</div>
              <div id="sourceBreakdown" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Follow-up Sidebar -->
    <div class="followup-sidebar">
      <div class="card">
        <div class="card-title" style="font-size:14px;">‚è∞ Follow Up Today</div>
        <div id="followupList"><div style="color:var(--gray-400);font-size:12px;text-align:center;padding:20px;">No follow-ups due today</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== TAB 4: AUTO-APPLY COMMAND CENTRE ========== -->
<div id="tab4" class="tab-content">
  <div class="grid-2" style="margin-bottom:24px;">
    <!-- Section A: Job Search Launcher -->
    <div class="card">
      <div class="card-title">üîç Job Search Launcher</div>
      <div class="grid-2">
        <div class="form-group">
          <label>Role Type</label>
          <select class="form-control" id="searchRoleType">
            <option>Business Analyst</option>
            <option>Product Owner</option>
            <option>Product Manager</option>
            <option>Business Development</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" class="form-control" id="searchLocation" value="Singapore">
        </div>
        <div class="form-group">
          <label>Experience Level</label>
          <select class="form-control" id="searchExp">
            <option>Mid</option>
            <option>Senior</option>
            <option>Lead</option>
          </select>
        </div>
        <div class="form-group">
          <label>Salary Min (SGD)</label>
          <input type="number" class="form-control" id="searchSalMin" placeholder="7000" value="7000">
        </div>
      </div>
      <div class="form-group">
        <label>Extra Keywords (optional)</label>
        <input type="text" class="form-control" id="searchKeywords" placeholder="e.g. Agile, FinTech, Loan IQ">
      </div>
      <button class="btn btn-primary" onclick="launchJobSearch()" style="width:100%;margin-bottom:16px;">üöÄ Search Now (Opens All Job Boards)</button>
      
      <div class="section-label">Quick Launch by Board</div>
      <div class="boards-grid">
        <button class="job-board-btn" onclick="openBoard('linkedin')">üíº LinkedIn</button>
        <button class="job-board-btn" onclick="openBoard('indeed')">üîé Indeed SG</button>
        <button class="job-board-btn" onclick="openBoard('glassdoor')">üè¢ Glassdoor</button>
        <button class="job-board-btn" onclick="openBoard('nodeflair')">‚ö° NodeFlair</button>
        <button class="job-board-btn" onclick="openBoard('jobstreet')">üìã Jobstreet</button>
      </div>

      <div class="divider"></div>
      <div class="section-label">üéØ Today's Target Companies</div>
      <div class="company-grid" id="targetCompanies"></div>
    </div>

    <!-- Section B: Application Kit Generator -->
    <div class="card">
      <div class="card-title">‚ö° Application Kit Generator</div>
      <div class="form-group">
        <label>Company Name</label>
        <input type="text" class="form-control" id="kitCompany" placeholder="e.g. Grab">
      </div>
      <div class="form-group">
        <label>Role Title</label>
        <input type="text" class="form-control" id="kitRole" placeholder="e.g. Lead Business Analyst">
      </div>
      <div class="form-group">
        <label>Role Type</label>
        <select class="form-control" id="kitRoleType">
          <option>Business Analyst</option>
          <option>Product Owner</option>
          <option>Product Manager</option>
          <option>Business Development</option>
        </select>
      </div>
      <div class="form-group">
        <label>Paste Job Description</label>
        <textarea class="form-control" id="kitJD" placeholder="Paste the full JD here..." style="min-height:120px;"></textarea>
      </div>
      <button class="btn btn-success" onclick="generateFullKit()" id="kitBtn" style="width:100%;margin-bottom:10px;">‚ö° Generate Full Application Kit</button>
      <button class="btn btn-secondary" onclick="openSpeedKit()" style="width:100%;margin-bottom:10px;">üèÉ Quick Apply Speed Kit (pre-filled answers)</button>
      <button class="btn btn-ghost" onclick="logApplicationFromKit()" id="logKitBtn" style="width:100%;">üìã Log This Application to Tracker</button>
    </div>
  </div>

  <!-- Three-panel output -->
  <div id="kitOutputSection" style="display:none;">
    <div class="card-title">üì¶ Your Application Kit</div>
    <div class="three-panels" id="kitPanels">
      <div class="panel-box">
        <div class="panel-header">üìÑ ATS-Optimised Resume <span id="kitKwScore" class="score-badge" style="font-size:10px;margin-left:6px;"></span></div>
        <div class="panel-body" id="kitResume">Generating...</div>
        <div class="panel-footer">
          <button class="btn btn-sm btn-secondary" onclick="copyPanel('kitResume')">üìã Copy</button>
          <button class="btn btn-sm btn-ghost" onclick="downloadOutput('kitResume','resume_'+Date.now()+'.txt')">‚¨á Download</button>
        </div>
      </div>
      <div class="panel-box">
        <div class="panel-header">‚úâÔ∏è Cover Letter</div>
        <div class="panel-body" id="kitCover">Generating...</div>
        <div class="panel-footer">
          <button class="btn btn-sm btn-secondary" onclick="copyPanel('kitCover')">üìã Copy</button>
          <button class="btn btn-sm btn-ghost" onclick="downloadOutput('kitCover','cover_'+Date.now()+'.txt')">‚¨á Download</button>
        </div>
      </div>
      <div class="panel-box">
        <div class="panel-header">üéØ Quick Interview Prep</div>
        <div class="panel-body" id="kitPrep">Generating...</div>
        <div class="panel-footer">
          <button class="btn btn-sm btn-secondary" onclick="copyPanel('kitPrep')">üìã Copy</button>
          <button class="btn btn-sm btn-ghost" onclick="downloadOutput('kitPrep','prep_'+Date.now()+'.txt')">‚¨á Download</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== TAB 5: SALARY & REFERRALS ========== -->
<div id="tab5" class="tab-content">
  <div class="grid-2">
    <!-- Salary Benchmarking -->
    <div class="card">
      <div class="card-title">üí∞ Singapore Salary Benchmarking</div>
      <div id="salaryBars" style="margin-bottom:20px;"></div>
      <div class="divider"></div>
      <div class="form-group">
        <label>Your Target Monthly Rate (SGD)</label>
        <input type="number" class="form-control" id="myTargetSalary" placeholder="e.g. 9000" oninput="checkSalaryPosition()">
      </div>
      <div id="salaryPositionMsg" style="margin-top:8px;"></div>
      <div class="divider"></div>
      <div style="background:var(--blue-pale);border:1.5px solid var(--blue-mid);border-radius:var(--radius-sm);padding:14px;">
        <div style="font-weight:700;color:var(--navy);font-size:13px;margin-bottom:8px;">üí° Negotiation Tip for Amretha</div>
        <div style="font-size:12.5px;color:var(--gray-700);line-height:1.6;">With your SAFe 6.0 certification, 5+ years at KPMG, and a proven track record of delivering 5% profit increase and saving 30 man-days through automation ‚Äî you are in the <strong>upper-mid band</strong> of the market. Anchor at <strong>10‚Äì15% above</strong> your target, cite your KPMG delivery metrics, and emphasise your dual strength in technical BA + Product Ownership. Singapore fintech firms pay a premium for SAFe-certified leads. For <strong>AI product roles</strong>, your hands-on Claude Opus 4.6 project is a tangible differentiator ‚Äî most candidates only have theory. Use it to justify the upper end of the range.</div>
      </div>
    </div>

    <!-- Referral Tracker -->
    <div class="card">
      <div class="card-title">ü§ù Referral Tracker</div>
      <button class="btn btn-primary btn-sm" onclick="openReferralModal()" style="margin-bottom:16px;">+ Add Referral Contact</button>
      <div id="referralList"><div style="color:var(--gray-400);font-size:12px;text-align:center;padding:30px;">No referral contacts yet. Add your first one!</div></div>
    </div>
  </div>

  <!-- Follow-up Email Generator -->
  <div class="card" style="margin-top:20px;">
    <div class="card-title">üìß Smart Follow-Up Email Generator</div>
    <div class="grid-2">
      <div>
        <div class="form-group">
          <label>Company Name</label>
          <input type="text" class="form-control" id="fuCompany" placeholder="e.g. Grab">
        </div>
        <div class="form-group">
          <label>Role Title</label>
          <input type="text" class="form-control" id="fuRole" placeholder="e.g. Lead Business Analyst">
        </div>
        <div class="form-group">
          <label>Days Since Application</label>
          <input type="number" class="form-control" id="fuDays" placeholder="e.g. 10" value="10">
        </div>
        <button class="btn btn-primary" onclick="generateFollowUp()">‚úâÔ∏è Generate Follow-Up Email</button>
      </div>
      <div>
        <div class="section-label">Generated Email</div>
        <div class="output-area" id="followUpOutput" style="margin-top:6px;min-height:160px;">
          <span class="output-placeholder">Your follow-up email will appear here...</span>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="copyPanel('followUpOutput')" style="margin-top:8px;display:none;" id="copyFuBtn">üìã Copy Email</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODALS ========== -->

<!-- AI Job Ranking Modal -->
<div class="modal-overlay" id="rankModal" style="display:none;">
  <div class="modal" style="max-width:700px;max-height:85vh;overflow-y:auto;">
    <button class="modal-close" onclick="closeModal('rankModal')">‚úï</button>
    <div class="modal-header">
      <div class="modal-title">üèÜ AI Job Fit Ranking</div>
      <div class="modal-subtitle">Claude analyses every job in your tracker against your profile and ranks them</div>
    </div>

    <div id="rankLoading" style="text-align:center;padding:40px;display:none;">
      <span class="spinner spinner-blue" style="width:32px;height:32px;border-width:3px;"></span>
      <div style="margin-top:16px;color:var(--gray-400);">Analysing your jobs against your profile...</div>
      <div style="margin-top:8px;font-size:12px;color:var(--gray-400);">This may take 15‚Äì30 seconds for large lists</div>
    </div>

    <div id="rankResults" style="display:none;">
      <div id="rankSummary" style="margin-bottom:16px;padding:12px;background:#f8fafc;border-radius:8px;font-size:13px;color:var(--gray-500);"></div>
      <div id="rankList"></div>
      <div style="margin-top:16px;text-align:center;">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('rankModal')">Close</button>
        <button class="btn btn-sm" style="background:#faf5ff;color:#7c3aed;border:1.5px solid #ddd6fe;margin-left:8px;" onclick="openRankModal()">üîÑ Re-run Analysis</button>
      </div>
    </div>

    <div id="rankEmpty" style="display:none;text-align:center;padding:40px;color:var(--gray-400);">
      <div style="font-size:32px;margin-bottom:12px;">üìã</div>
      <div>No jobs in your tracker yet. Add some jobs first, then rank them!</div>
    </div>

    <div id="rankError" style="display:none;padding:16px;background:#fff1f2;border-radius:8px;color:#dc2626;font-size:14px;"></div>
  </div>
</div>

<!-- Import Job Modal -->
<div class="modal-overlay" id="importJobModal" style="display:none;">
  <div class="modal" style="max-width:560px;">
    <button class="modal-close" onclick="closeModal('importJobModal')">‚úï</button>
    <div class="modal-header">
      <div class="modal-title">üîó Import Job from URL</div>
      <div class="modal-subtitle">Paste a LinkedIn or Indeed job URL to auto-fill details</div>
    </div>

    <!-- Bookmarklet Section -->
    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:14px;margin-bottom:16px;color:white;">
      <div style="font-weight:600;margin-bottom:6px;">üîñ 1-Click Bookmarklet ‚Äî Import from LinkedIn</div>
      <div style="font-size:12px;opacity:0.9;margin-bottom:10px;">
        ‚ë† On any <strong>LinkedIn job page</strong> ‚Üí saves that job instantly<br>
        ‚ë° On <strong>linkedin.com/my-items/saved-jobs/</strong> ‚Üí imports ALL saved jobs at once üöÄ
      </div>
      <div style="font-size:12px;font-weight:600;margin-bottom:6px;">One-time setup:</div>
      <div style="font-size:12px;opacity:0.9;margin-bottom:10px;line-height:1.9;">
        1. Show bookmarks bar: <strong>Cmd+Shift+B</strong> (Mac) / <strong>Ctrl+Shift+B</strong> (Windows)<br>
        2. <strong>Select all text</strong> in the box below and copy it (Cmd+A, Cmd+C)<br>
        3. Right-click bookmarks bar ‚Üí <strong>Add page</strong> (Chrome) / <strong>New Bookmark</strong> (Safari)<br>
        4. Name: <strong>Send to Job Tracker</strong> ¬∑ paste as the URL ‚Üí Save
      </div>
      <textarea id="bookmarkletBox" readonly
        style="width:100%;height:60px;font-size:10px;font-family:monospace;border-radius:6px;padding:8px;box-sizing:border-box;background:#1e1b4b;color:#a5b4fc;border:none;resize:none;cursor:text;"
        onclick="this.select();" onfocus="this.select();"
        placeholder="Loading...">Loading bookmarklet code...</textarea>
      <div style="font-size:11px;opacity:0.8;margin-top:6px;text-align:center;">üëÜ Click the box to select all, then Cmd+C / Ctrl+C to copy</div>
    </div>

    <div style="margin-bottom:16px;">
      <label class="form-label">Job URL</label>
      <div style="display:flex;gap:8px;">
        <input id="importUrl" type="url" class="form-input" placeholder="https://www.linkedin.com/jobs/view/... or https://sg.indeed.com/..." style="flex:1;" />
        <button class="btn btn-primary" onclick="importJobFromUrl()" id="importBtn" style="white-space:nowrap;">üîç Parse URL</button>
      </div>
      <div id="importStatus" style="margin-top:8px;font-size:13px;color:var(--gray-400);"></div>
    </div>

    <div id="importFormFields" style="display:none;">
      <div class="form-row">
        <div>
          <label class="form-label">Job Title *</label>
          <input id="importTitle" class="form-input" placeholder="e.g. Product Owner" />
        </div>
        <div>
          <label class="form-label">Company *</label>
          <input id="importCompany" class="form-input" placeholder="e.g. Grab" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">Role Type</label>
          <select id="importRoleType" class="form-input">
            <option>Product Owner</option>
            <option>Product Manager</option>
            <option>Business Analyst</option>
            <option>AI Product Manager</option>
            <option>AI Business Analyst</option>
            <option>Senior Business Analyst</option>
          </select>
        </div>
        <div>
          <label class="form-label">Location</label>
          <input id="importLocation" class="form-input" value="Singapore" />
        </div>
      </div>
      <div>
        <label class="form-label">Job Description (paste if not auto-filled)</label>
        <textarea id="importDescription" class="form-input" rows="5" placeholder="Paste job description here..."></textarea>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button class="btn btn-primary" onclick="saveImportedJob()" style="flex:1;">‚úÖ Add to Tracker</button>
        <button class="btn btn-ghost" onclick="closeModal('importJobModal')">Cancel</button>
      </div>
    </div>

    <div style="margin-top:16px;padding:12px;background:#f8fafc;border-radius:8px;font-size:12px;color:var(--gray-400);">
      <strong>üí° How to use:</strong> Paste the job URL ‚Üí click Parse URL ‚Üí the form fills what it can from the URL. Then <strong>copy the job description from LinkedIn/Indeed</strong> (while logged in on that page) and paste it below. Or use the <strong>üîñ Bookmarklet</strong> to send jobs in 1 click!
    </div>
  </div>
</div>

<!-- Add Job Modal -->
<div class="modal-overlay" id="addJobModal" style="display:none;">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addJobModal')">‚úï</button>
    <div class="modal-title">‚ûï Add New Job Application</div>
    <div class="grid-2">
      <div class="form-group"><label>Company Name *</label><input type="text" class="form-control" id="mCompany" placeholder="e.g. Grab"></div>
      <div class="form-group"><label>Role Title *</label><input type="text" class="form-control" id="mRole" placeholder="e.g. Lead Business Analyst"></div>
      <div class="form-group"><label>Role Type</label><select class="form-control" id="mRoleType"><option>Business Analyst</option><option>Product Owner</option><option>Product Manager</option><option>Business Development</option></select></div>
      <div class="form-group"><label>Status</label><select class="form-control" id="mStatus"><option value="saved">Saved</option><option value="applied">Applied</option><option value="screen">Recruiter Screen</option><option value="interview">Interviewing</option><option value="offer">Offer</option><option value="rejected">Rejected</option></select></div>
      <div class="form-group"><label>JD URL</label><input type="url" class="form-control" id="mUrl" placeholder="https://..."></div>
      <div class="form-group"><label>Salary (SGD/month)</label><input type="text" class="form-control" id="mSalary" placeholder="e.g. 9000 - 12000"></div>
      <div class="form-group"><label>Source</label><select class="form-control" id="mSource"><option>LinkedIn</option><option>Referral</option><option>Direct</option><option>Recruiter</option><option>JobStreet</option><option>Indeed</option><option>NodeFlair</option></select></div>
      <div class="form-group"><label>Priority</label><select class="form-control" id="mPriority"><option>High</option><option>Medium</option><option>Low</option></select></div>
    </div>
    <div class="form-group"><label>Notes</label><textarea class="form-control" id="mNotes" placeholder="Any notes about this role..." style="min-height:70px;"></textarea></div>
    <div class="flex-row" style="margin-top:16px;">
      <button class="btn btn-primary" onclick="saveJob()">üíæ Save Job</button>
      <button class="btn btn-ghost" onclick="closeModal('addJobModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Checklist Modal -->
<div class="modal-overlay" id="checklistModal" style="display:none;">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('checklistModal')">‚úï</button>
    <div class="modal-title" id="checklistTitle">‚úÖ Application Checklist</div>
    <div id="checklistItems"></div>
    <button class="btn btn-primary" onclick="saveChecklist()" style="margin-top:16px;">üíæ Save Progress</button>
  </div>
</div>

<!-- Apply Kit Popup -->
<div class="modal-overlay" id="applyKitModal" style="display:none;">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeModal('applyKitModal')">‚úï</button>
    <div class="modal-title" id="applyKitTitle">‚ö° Apply Kit</div>
    <div id="applyKitContent" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;"></div>
  </div>
</div>

<!-- Referral Modal -->
<div class="modal-overlay" id="referralModal" style="display:none;">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('referralModal')">‚úï</button>
    <div class="modal-title">ü§ù Add Referral Contact</div>
    <div class="form-group"><label>Name *</label><input type="text" class="form-control" id="rName" placeholder="Full name"></div>
    <div class="form-group"><label>Company</label><input type="text" class="form-control" id="rCompany" placeholder="Company name"></div>
    <div class="form-group"><label>Role They Can Refer You For</label><input type="text" class="form-control" id="rRole" placeholder="e.g. Lead BA at Grab"></div>
    <div class="form-group"><label>LinkedIn URL</label><input type="url" class="form-control" id="rLinkedIn" placeholder="https://linkedin.com/in/..."></div>
    <div class="form-group"><label>Status</label><select class="form-control" id="rStatus"><option>Not Contacted</option><option>Reached Out</option><option>In Discussion</option><option>Referred</option><option>No Response</option></select></div>
    <div class="form-group"><label>Notes</label><textarea class="form-control" id="rNotes" placeholder="Any notes..." style="min-height:70px;"></textarea></div>
    <div class="flex-row" style="margin-top:16px;">
      <button class="btn btn-primary" onclick="saveReferral()">üíæ Save Contact</button>
      <button class="btn btn-ghost" onclick="closeModal('referralModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Job Detail Modal -->
<div class="modal-overlay" id="jobDetailModal" style="display:none;">
  <div class="modal" style="max-width:640px;">
    <button class="modal-close" onclick="closeModal('jobDetailModal')">‚úï</button>
    <div class="modal-title" id="jdModalTitle">üìã Job Details</div>

    <!-- Header info row -->
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px;">
      <div>
        <div style="font-size:18px;font-weight:800;color:var(--navy);" id="jdModalCompany"></div>
        <div style="font-size:14px;color:var(--gray-500);margin-top:3px;" id="jdModalRole"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;" id="jdModalBadges"></div>
      </div>
      <a id="jdModalApplyBtn" href="#" target="_blank" rel="noopener"
         style="display:none;flex-shrink:0;padding:10px 20px;background:var(--blue);color:white;border-radius:8px;font-weight:700;font-size:13px;text-decoration:none;white-space:nowrap;box-shadow:0 2px 8px rgba(26,86,219,0.25);">
        üîó Apply Now
      </a>
    </div>

    <!-- Apply URL display -->
    <div id="jdModalUrlRow" style="display:none;margin-bottom:14px;">
      <div style="font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Apply Link</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <input id="jdModalUrlText" readonly type="text"
               style="flex:1;font-size:12px;font-family:monospace;padding:7px 10px;border-radius:6px;border:1.5px solid var(--gray-200);background:var(--gray-50);color:var(--gray-700);outline:none;cursor:text;"
               onclick="this.select();" />
        <button class="btn btn-xs btn-secondary" onclick="copyJobUrl()">üìã Copy</button>
      </div>
    </div>

    <!-- No URL notice -->
    <div id="jdModalNoUrl" style="display:none;margin-bottom:14px;padding:10px 14px;background:#fff7ed;border:1.5px solid #fed7aa;border-radius:8px;font-size:12px;color:#92400e;">
      ‚ö†Ô∏è No apply link saved for this job. Add one by editing the card.
    </div>

    <!-- JD section -->
    <div style="font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">Job Description</div>
    <div id="jdModalJD"
         style="background:var(--gray-50);border:1.5px solid var(--gray-200);border-radius:8px;padding:14px;font-size:13px;line-height:1.7;color:var(--gray-700);max-height:340px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;">
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-xs btn-secondary" onclick="copyJobJD()">üìã Copy JD</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:18px;flex-wrap:wrap;">
      <button class="btn btn-primary" id="jdModalKitBtn" onclick="">‚ö° Generate Apply Kit</button>
      <button class="btn btn-ghost" onclick="closeModal('jobDetailModal')">Close</button>
    </div>
  </div>
</div>


  <div class="modal modal-lg" style="max-width:700px;">
    <button class="modal-close" onclick="closeModal('speedKitModal')">‚úï</button>
    <div class="modal-title">üèÉ Quick Apply Speed Kit</div>
    <div style="background:var(--blue-pale);border:1.5px solid var(--blue-mid);border-radius:10px;padding:12px 14px;margin-bottom:20px;font-size:13px;color:var(--navy);">
      <strong>How to use:</strong> Copy each answer ‚Üí paste directly into the application form. Under 3 minutes per job. Answers are framed for <strong>in-house product roles</strong>, not consulting.
    </div>
    <div id="speedKitContent"></div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ========== PROFILE DATA ==========
const PROFILE = {
  name: "Amretha Karthikeyan",
  address: "#02-321 153 Gangsa Road, Singapore-670153",
  mobile: "+65-90256503",
  email: "amretha.ammu@gmail.com",
  linkedin: "https://www.linkedin.com/in/amretha-nishanth-534b39101/",
  headline: "Product Owner | Lead BA | Fintech & Digital Products ¬∑ Singapore",
  aiProjectUrl: "https://stock-monitor-8ak6.onrender.com",
  summary: "SAFe 6.0 certified Product Owner and Lead Business Analyst with 5+ years owning product backlogs and driving digital product delivery in fintech and banking. At KPMG Singapore, served as de-facto Product Owner for Loan IQ ‚Äî a core banking platform ‚Äî leading cross-functional squads (engineering, UX, QA) to ship features and deliver measurable business outcomes. Seeking in-house product roles to own roadmaps end-to-end, from discovery through to scale.",
  skills: ["Tableau", "Power BI", "PSQL", "Python", "Agile", "JIRA", "Excel", "Microsoft Project", "Product Vision", "Roadmapping", "Business Analysis", "Risk Mitigation", "Change Management", "Budget Forecasting", "Variance Analysis", "KPI Tracking", "Dashboard Reporting", "Event Facilitation", "SAFe 6.0", "API integrations", "Loan IQ", "SQL", "Stakeholder Management", "Generative AI", "LLM", "Claude API", "AI product development", "prompt engineering", "AI-powered applications"],
  certification: "Scaled Agile Framework 6.0 Product Owner/Product Management",
  experience: [
    {
      company: "KPMG, Singapore",
      role: "Lead Business Analyst ‚Äì Functional Consultant ‚Äì Loan IQ",
      period: "Feb 2021 ‚Äì Present",
      bullets: [
        "Partnered with Enterprise Singapore on large-scale digital transformation projects",
        "Supported executive decision-making through As-Is/To-Be analysis and streamlined documentation of strategic processes across finance teams",
        "Collaborated with cross-regional stakeholders (UX, architecture, finance) to drive alignment across engineering and operations functions",
        "Managed internal reporting cycles, change requests, and approval workflows contributing to 5% increase in project profitability",
        "Owned and prioritised product backlog, ensuring alignment with business objectives, regulatory requirements and customer experience goals",
        "Trained vendors and managed go-live execution plans, ensuring process continuity across business units",
        "Conducted internal workshops to drive operational readiness and team-wide coordination",
        "Analysed complex problems, carried out root cause analysis creating innovative solutions with UX, architecture and software solutioning teams",
        "Experience in API integrations; designed, documented and executed end-to-end test scenarios on Loan IQ Product Applications (M&A, Trade, WCL, FA)",
        "Led Testers, Interns and Junior Business Analysts for Scrum activities (Planning, Closure, Retro)"
      ],
      achievements: [
        "Performed accurate Impact Analysis and persuaded clients to approve Change Request items, generating additional profit of ~5% of Project Cost",
        "Analysed and provided solutioning for Automated Interest Computation (financial services), saving 30 man-days of work",
        "Led the team during a critical transition phase from Sprint end to SIT, maintaining project delivery timeline"
      ]
    },
    {
      company: "J.P. Morgan",
      role: "Asset Management Virtual Internship",
      period: "Oct 2023 ‚Äì Jan 2024",
      bullets: [
        "Helped traders and clients build stronger investment portfolios with market-leading solutions",
        "Gathered business requirements from trading/execution teams; built robust investor profiles through structured questionnaires",
        "Performed quantitative fundamental analysis of 5 stocks and recommended to 2 clients based on risk appetite metrics",
        "Measured investment success via KPIs: Annual Portfolio Return, Portfolio Variance, Portfolio Standard Deviation"
      ]
    },
    {
      company: "Amazon Inc, India",
      role: "Business Analyst",
      period: "Mar 2018 ‚Äì Mar 2019",
      bullets: [
        "Analysed and translated business requirements into functional and non-functional specifications",
        "Worked closely with stakeholders to understand needs, scope problems, and develop business cases from data",
        "Developed real-time monitoring quality metrics using Power BI from SQL Server and MS Excel",
        "Analysed and visualised data using Tableau/Power BI model building"
      ]
    }
  ],
  education: [
    { degree: "Master of Science ‚Äì Engineering Business Management", school: "Coventry University, UK", period: "Jul 2019 ‚Äì Nov 2020" },
    { degree: "Bachelor of Engineering ‚Äì Electronics & Communication", school: "Anna University, India", period: "Jul 2012 ‚Äì Jun 2016" }
  ],
  projects: [
    {
      title: "AI-Powered Trade Analysis Platform",
      type: "Personal Project",
      period: "2025",
      url: "https://stock-monitor-8ak6.onrender.com",
      tech: "Claude Opus 4.6 (Anthropic), Python, Web Development",
      bullets: [
        "Designed and built a LIVE web-based Trade Analysis platform leveraging Claude Opus 4.6 (Anthropic's LLM) ‚Äî deployed at https://stock-monitor-8ak6.onrender.com ‚Äî performing combined financial trade data and international trade flow analysis",
        "Integrated generative AI to automate interpretation of complex market data, surfacing actionable insights from multi-dimensional financial and macroeconomic datasets",
        "Demonstrated hands-on AI product development capability ‚Äî from prompt engineering and LLM integration through to end-user web interface delivery",
        "Showcases ability to identify a real analytical problem, define product requirements, and ship an AI-powered solution independently"
      ]
    }
  ]
};

// ========== CLAUDE API CALL ==========
// ‚îÄ‚îÄ‚îÄ BACKEND API CALLS (no API key needed in browser) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function callBackend(endpoint, payload) {
  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `Server error ${res.status}`);
  }
  return res.json();
}

// Kept for compatibility ‚Äî routes through backend now
async function callClaude(prompt, systemPrompt = "") {
  const res = await callBackend("/api/generic", { prompt, systemPrompt });
  return res.result;
}

// ========== TOAST ==========
function toast(msg, type = "") {
  const t = document.createElement("div");
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.getElementById("toastContainer").appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ========== TAB SWITCHING ==========


// ‚îÄ‚îÄ‚îÄ AI JOB RANKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function openRankModal() {
  // Reset state
  document.getElementById('rankLoading').style.display = 'none';
  document.getElementById('rankResults').style.display = 'none';
  document.getElementById('rankEmpty').style.display = 'none';
  document.getElementById('rankError').style.display = 'none';
  openModal('rankModal');

  const realJobs = jobs.filter(j => !j.isDemo);
  if (realJobs.length === 0) {
    document.getElementById('rankEmpty').style.display = 'block';
    return;
  }

  document.getElementById('rankLoading').style.display = 'block';

  try {
    // Send jobs to backend for ranking
    const payload = realJobs.map(j => ({
      id: j.id,
      role: j.role,
      company: j.company,
      roleType: j.roleType || '',
      jd: j.jd || ''
    }));

    const data = await callBackend('/api/rank-jobs', { jobs: payload });

    document.getElementById('rankLoading').style.display = 'none';

    if (data.error) {
      document.getElementById('rankError').style.display = 'block';
      document.getElementById('rankError').textContent = 'Error: ' + data.error;
      return;
    }

    // Sort rankings by score descending
    const rankings = data.rankings.sort((a, b) => b.score - a.score);

    // Build lookup map
    const jobMap = {};
    realJobs.forEach(j => { jobMap[j.id] = j; });

    // Render summary
    const topJobs = rankings.filter(r => r.score >= 7);
    const skipJobs = rankings.filter(r => r.score <= 4);
    document.getElementById('rankSummary').innerHTML = 
      `Analysed <strong>${rankings.length} jobs</strong> ‚Äî <strong style="color:#15803d">${topJobs.length} strong matches</strong>, ` +
      `<strong style="color:#dc2626">${skipJobs.length} weak fits</strong>. Focus your energy on the top ones first.`;

    // Render ranked list
    const scoreColors = {
      'üî• Strong Match': '#fef3c7',
      '‚úÖ Good Fit': '#f0fdf4',
      'üü° Possible': '#fffbeb',
      '‚ùå Weak Fit': '#fff1f2'
    };
    const scoreBorderColors = {
      'üî• Strong Match': '#fde68a',
      '‚úÖ Good Fit': '#bbf7d0',
      'üü° Possible': '#fed7aa',
      '‚ùå Weak Fit': '#fecdd3'
    };
    const priorityColors = {
      'Apply Today': '#dc2626',
      'Apply This Week': '#d97706',
      'Lower Priority': '#6b7280',
      'Skip': '#9ca3af'
    };

    let html = '';
    rankings.forEach((r, idx) => {
      const job = jobMap[r.id] || {};
      const bg = scoreColors[r.label] || '#f8fafc';
      const border = scoreBorderColors[r.label] || '#e2e8f0';
      const priColor = priorityColors[r.priority] || '#6b7280';

      html += `<div style="margin-bottom:12px;padding:14px;background:${bg};border:1.5px solid ${border};border-radius:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:18px;font-weight:700;color:var(--gray-600);">#${idx+1}</span>
            <div>
              <div style="font-weight:600;font-size:15px;">${job.role || r.id}</div>
              <div style="font-size:13px;color:var(--gray-500);">${job.company || ''}</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px;font-weight:600;">${r.label}</div>
            <div style="font-size:22px;font-weight:800;color:var(--blue);">${r.score}<span style="font-size:13px;font-weight:400;color:var(--gray-400);">/10</span></div>
          </div>
        </div>
        <div style="font-size:13px;color:var(--gray-600);margin-bottom:8px;">${r.reason}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:12px;font-weight:600;color:${priColor};">‚è∞ ${r.priority}</span>
          <button onclick="closeModal('rankModal');switchTab('tab1',document.querySelector('.tab-btn'));document.getElementById('t1JD').value=${JSON.stringify(job.jd||'')};document.getElementById('t1RoleType').value=${JSON.stringify(job.roleType||'Business Analyst')};" 
            style="font-size:12px;padding:4px 10px;background:white;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;color:var(--blue);">
            ‚ú® Tailor Resume ‚Üí
          </button>
        </div>
      </div>`;
    });

    document.getElementById('rankList').innerHTML = html;
    document.getElementById('rankResults').style.display = 'block';

  } catch(e) {
    document.getElementById('rankLoading').style.display = 'none';
    document.getElementById('rankError').style.display = 'block';
    document.getElementById('rankError').textContent = 'Error: ' + e.message;
  }
}

// ‚îÄ‚îÄ‚îÄ IMPORT JOB FROM URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openImportModal() {
  document.getElementById('importUrl').value = '';
  document.getElementById('importStatus').textContent = '';
  document.getElementById('importFormFields').style.display = 'none';
  document.getElementById('importTitle').value = '';
  document.getElementById('importCompany').value = '';
  document.getElementById('importDescription').value = '';
  document.getElementById('importLocation').value = 'Singapore';
  openModal('importJobModal');
  copyBookmarklet();
}

function importJobFromUrl() {
  const url = document.getElementById('importUrl').value.trim();
  if (!url) { toast('Please paste a URL first', 'error'); return; }

  const status = document.getElementById('importStatus');

  // Parse what we can from the URL itself (no scraping needed)
  let company = '', title = '', platform = '';

  if (url.includes('linkedin.com')) {
    platform = 'LinkedIn';
    // Extract company/title hints from URL slug
    // e.g. /jobs/view/product-owner-at-grab-123456/
    const slugMatch = url.match(/\/jobs\/view\/([^/?]+)/);
    if (slugMatch) {
      const slug = slugMatch[1].replace(/-\d+$/, ''); // remove trailing job ID
      const atIdx = slug.lastIndexOf('-at-');
      if (atIdx > 0) {
        title = slug.substring(0, atIdx).replace(/-/g, ' ').replace(/\w/g, c => c.toUpperCase());
        company = slug.substring(atIdx + 4).replace(/-/g, ' ').replace(/\w/g, c => c.toUpperCase());
      } else {
        title = slug.replace(/-/g, ' ').replace(/\w/g, c => c.toUpperCase());
      }
    }
    status.innerHTML = '‚úÖ LinkedIn URL detected! Title & company extracted from URL. <strong>Please paste the job description below</strong> (copy from the LinkedIn page while you are logged in).';
    status.style.color = '#15803d';
  } else if (url.includes('indeed.com')) {
    platform = 'Indeed';
    status.innerHTML = '‚úÖ Indeed URL detected! <strong>Please paste the job description below</strong> (copy from the Indeed page).';
    status.style.color = '#15803d';
  } else if (url.includes('mycareersfuture.gov.sg')) {
    platform = 'MyCareersFuture';
    status.innerHTML = '‚úÖ MyCareersFuture URL detected! <strong>Paste the job description below</strong>.';
    status.style.color = '#15803d';
  } else {
    status.textContent = '‚úÖ URL saved. Fill in the details below.';
    status.style.color = '#15803d';
  }

  // Pre-fill what we extracted
  if (title) document.getElementById('importTitle').value = title;
  if (company) document.getElementById('importCompany').value = company;

  // Guess role type from title
  const tl = title.toLowerCase();
  const roleSelect = document.getElementById('importRoleType');
  if (tl.includes('product owner') || tl.includes(' po ')) roleSelect.value = 'Product Owner';
  else if (tl.includes('product manager') || tl.includes(' pm')) roleSelect.value = 'Product Manager';
  else if (tl.includes('ai') || tl.includes('machine learning')) roleSelect.value = 'AI Product Manager';
  else if (tl.includes('business analyst')) roleSelect.value = 'Business Analyst';

  document.getElementById('importFormFields').style.display = 'block';
  document.getElementById('importDescription').focus();
}

function saveImportedJob() {
  const title = document.getElementById('importTitle').value.trim();
  const company = document.getElementById('importCompany').value.trim();
  if (!title || !company) { toast('Title and Company are required', 'error'); return; }

  const job = {
    id: Date.now(),
    role: title,
    company: company,
    roleType: document.getElementById('importRoleType').value,
    location: document.getElementById('importLocation').value || 'Singapore',
    url: document.getElementById('importUrl').value.trim(),
    jd: document.getElementById('importDescription').value.trim(),
    status: 'wishlist',
    date: new Date().toLocaleDateString('en-GB'),
    notes: '',
    salary: '',
    isDemo: false
  };

  jobs.push(job);
  saveJobs(jobs);
  renderKanban();
  updateStats();
  renderAnalytics();
  closeModal('importJobModal');
  toast(`‚úÖ "${title}" at ${company} added to tracker!`, 'success');
}

function switchTab(tabId, btn) {
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  btn.classList.add("active");
  if (tabId === 'tab3') { renderKanban(); updateStats(); renderAnalytics(); }
  if (tabId === 'tab5') { renderSalaryBars(); renderReferrals(); }
}

// ========== DATE HELPERS ==========
function sgDate(d) {
  const date = d ? new Date(d) : new Date();
  const dd = String(date.getDate()).padStart(2,'0');
  const mm = String(date.getMonth()+1).padStart(2,'0');
  const yyyy = date.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}
function daysSince(dateStr) {
  if (!dateStr) return 0;
  const diff = Date.now() - new Date(dateStr).getTime();
  return Math.floor(diff / (1000*60*60*24));
}

// Set header date
document.getElementById("headerDate").textContent = sgDate();

// ========== DAILY GOAL ==========
function getGoalData() {
  const today = new Date().toDateString();
  let g = JSON.parse(localStorage.getItem("goalData") || "{}");
  if (g.date !== today) { g = { date: today, count: 0 }; localStorage.setItem("goalData", JSON.stringify(g)); }
  return g;
}
function updateGoalDisplay() {
  const target = parseInt(document.getElementById("dailyGoalTarget").value) || 5;
  const g = getGoalData();
  const pct = Math.min(100, Math.round((g.count / target) * 100));
  document.getElementById("goalBarFill").style.width = pct + "%";
  document.getElementById("goalText").textContent = `${g.count} / ${target} today ${pct >= 100 ? "‚úÖ" : ""}`;
  const streak = parseInt(localStorage.getItem("streak") || "0");
  document.getElementById("streakBadge").textContent = `üî• ${streak} day streak`;
}
function incrementGoal() {
  const g = getGoalData();
  g.count++;
  localStorage.setItem("goalData", JSON.stringify(g));
  const target = parseInt(document.getElementById("dailyGoalTarget").value) || 5;
  if (g.count === target) { toast("üéâ Daily goal reached!", "success"); let streak = parseInt(localStorage.getItem("streak")||0); localStorage.setItem("streak", streak+1); }
  updateGoalDisplay();
}
updateGoalDisplay();

// ========== KEYWORD ANALYSIS ==========
function isAIRole(jd, roleType) {
  const aiTerms = ["ai","artificial intelligence","machine learning","ml","llm","generative ai","genai","nlp","gpt","claude","openai","foundation model","large language model","ai product","data science","analytics","ai-powered","intelligent automation","conversational ai"];
  const text = (jd + " " + roleType).toLowerCase();
  return aiTerms.some(t => text.includes(t));
}

function analyzeKeywords(jd, roleType) {
  const jdLower = jd.toLowerCase();
  const coreKws = ["agile","stakeholder","business analysis","requirements","kpi","reporting","jira","product","process","data","documentation","transformation","scrum","risk","management"];
  const roleKws = {
    "Business Analyst": ["as-is","to-be","gap analysis","user stories","uat","functional specification","process mapping","use cases","brd","frd","sql","data migration"],
    "Product Owner": ["backlog","product backlog","sprint","user stories","product vision","roadmap","acceptance criteria","velocity","release planning","mvp","safe","scaled agile"],
    "Product Manager": ["product strategy","go-to-market","product roadmap","market research","competitive analysis","okr","product vision","customer journey","revenue","growth","metrics"],
    "Business Development": ["sales","revenue","pipeline","partnerships","crm","lead generation","negotiation","client acquisition","business growth","b2b","market expansion","deals"]
  };
  // Boost AI keywords if JD is AI-related
  const aiKws = ["generative ai","llm","machine learning","ai","prompt engineering","nlp","foundation model","ai product","claude","openai","data science","intelligent automation","ai-powered","model evaluation","rag","fine-tuning"];
  if (isAIRole(jdLower, roleType)) { allKws.push(...aiKws); }
  const allKws = [...coreKws, ...(roleKws[roleType] || [])];
  const found = allKws.filter(k => jdLower.includes(k));
  const missing = allKws.filter(k => !jdLower.includes(k));
  const score = Math.round((found.length / allKws.length) * 100);
  return { found, missing, score };
}

// ========== TAB 1: RESUME TAILORER ==========
async function tailorResume() {
  const jd = document.getElementById("t1JD").value.trim();
  const roleType = document.getElementById("t1RoleType").value;
  if (!jd) { toast("Please paste a job description first", "error"); return; }
  
  const btn = document.getElementById("tailorBtn");
  btn.innerHTML = '<span class="spinner"></span> Tailoring...';
  btn.disabled = true;
  document.getElementById("resumeOutput").innerHTML = '<div style="text-align:center;padding:40px;"><span class="spinner spinner-blue"></span><div style="margin-top:12px;color:var(--gray-400);">AI is tailoring your resume...</div></div>';

  const { found, missing, score } = analyzeKeywords(jd, roleType);

  try {
    const data = await callBackend("/api/tailor-resume", { jd, roleType });
    document.getElementById("resumeOutput").textContent = data.result;
    document.getElementById("dlResumeBtn").style.display = "inline-flex";
    document.getElementById("keywordCard").style.display = "block";
    const scoreEl = document.getElementById("kwScore");
    scoreEl.textContent = `${score}/100`;
    scoreEl.className = `score-badge ${score >= 70 ? "score-high" : score >= 40 ? "score-mid" : "score-low"}`;
    document.getElementById("kwFound").innerHTML = found.map(k => `<span class="keyword-chip chip-found">‚úì ${k}</span>`).join("");
    document.getElementById("kwMissing").innerHTML = missing.map(k => `<span class="keyword-chip chip-missing">‚úó ${k}</span>`).join("");
    toast("Resume tailored successfully!", "success");
  } catch(e) {
    document.getElementById("resumeOutput").textContent = "Error: " + e.message;
    toast("Error: " + e.message, "error");
  }
  btn.innerHTML = "‚ú® Tailor My Resume";
  btn.disabled = false;
}

async function generateCoverLetter() {
  const jd = document.getElementById("t1JD").value.trim();
  const roleType = document.getElementById("t1RoleType").value;
  if (!jd) { toast("Please paste a job description first", "error"); return; }
  const btn = document.getElementById("coverBtn");
  btn.innerHTML = '<span class="spinner"></span> Writing...';
  btn.disabled = true;
  document.getElementById("coverOutput").innerHTML = '<div style="text-align:center;padding:40px;"><span class="spinner spinner-blue"></span><div style="margin-top:12px;color:var(--gray-400);">Writing your cover letter...</div></div>';
  try {
    const data = await callBackend("/api/cover-letter", { jd, roleType, company: "the company" });
    document.getElementById("coverOutput").textContent = data.result;
    document.getElementById("dlCoverBtn").style.display = "inline-flex";
    toast("Cover letter generated!", "success");
  } catch(e) {
    document.getElementById("coverOutput").textContent = "Error: " + e.message;
    toast("Error: " + e.message, "error");
  }
  btn.innerHTML = "üìù Generate Cover Letter";
  btn.disabled = false;
}

// ========== TAB 2: INTERVIEW PREP ==========
async function generateInterviewPrep() {
  const company = document.getElementById("t2Company").value.trim() || "the company";
  const roleType = document.getElementById("t2RoleType").value;
  const jd = document.getElementById("t2JD").value.trim();
  const btn = document.getElementById("prepBtn");
  btn.innerHTML = '<span class="spinner"></span> Preparing...';
  btn.disabled = true;
  document.getElementById("prepOutputArea").innerHTML = '<div style="text-align:center;padding:60px;"><span class="spinner spinner-blue" style="width:32px;height:32px;border-width:3px;"></span><div style="margin-top:16px;color:var(--gray-400);">Generating your personalised interview prep...</div></div>';
  try {
    const data = await callBackend("/api/interview-prep", { company, roleType, jd });
    document.getElementById("prepOutputArea").innerHTML = formatPrepOutput(data.result);
    toast("Interview prep ready!", "success");
  } catch(e) {
    document.getElementById("prepOutputArea").innerHTML = `<div class="card"><p style="color:red;">Error: ${e.message}</p></div>`;
    toast("Error: " + e.message, "error");
  }
  btn.innerHTML = "üöÄ Prepare Me for Interview";
  btn.disabled = false;
}

function formatPrepOutput(text) {
  const sections = text.split(/\n## /).filter(Boolean);
  let html = "";
  sections.forEach(section => {
    const [title, ...body] = section.split("\n");
    html += `<div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="font-size:15px;">${title.replace(/^##\s*/,"")}</div>
      <div style="font-size:13px;line-height:1.7;color:var(--gray-700);white-space:pre-wrap;">${body.join("\n")}</div>
    </div>`;
  });
  if (!html) html = `<div class="card"><div style="font-size:13px;line-height:1.7;color:var(--gray-700);white-space:pre-wrap;">${text}</div></div>`;
  return html;
}

// ========== JOB STORAGE ==========
const COLS = ["saved","applied","screen","interview","offer","rejected"];
const COL_LABELS = { saved:"üíæ Saved", applied:"üì® Applied", screen:"üìû Recruiter Screen", interview:"üéôÔ∏è Interviewing", offer:"üèÜ Offer", rejected:"‚ùå Rejected" };
const COL_COLORS = { saved:"#6b7280", applied:"#3b82f6", screen:"#f59e0b", interview:"#8b5cf6", offer:"#10b981", rejected:"#ef4444" };

function getJobs() { return JSON.parse(localStorage.getItem("jobs") || "[]"); }
function saveJobs(jobs) { localStorage.setItem("jobs", JSON.stringify(jobs)); localStorage.setItem("jobs_initialized", "true"); }

function initSampleJobs() {
  // Only show demo cards on first ever visit ‚Äî not after user clears them
  if (localStorage.getItem("jobs_initialized")) return;
  localStorage.setItem("jobs_initialized", "true");
  const today = new Date();
  const d8 = new Date(today); d8.setDate(today.getDate()-8);
  const d3 = new Date(today); d3.setDate(today.getDate()-3);
  const d1 = new Date(today); d1.setDate(today.getDate()-1);
  saveJobs([
    { id: "j1", company: "Grab", role: "Product Owner ‚Äì Payments & Disbursements", roleType: "Product Owner", status: "interview", salary: "11,000 ‚Äì 14,000", priority: "High", url: "https://grab.careers", source: "LinkedIn", notes: "‚ö†Ô∏è DEMO ‚Äî delete before use. In-house PO role for GrabPay squad.", dateApplied: d8.toISOString(), checklist: {}, isDemo: true },
    { id: "j2", company: "Sea Limited / Shopee", role: "Senior Product Manager ‚Äì Seller Experience", roleType: "Product Manager", status: "applied", salary: "12,000 ‚Äì 16,000", priority: "High", url: "https://careers.sea.com", source: "LinkedIn", notes: "‚ö†Ô∏è DEMO ‚Äî delete before use. In-house PM owning seller onboarding product.", dateApplied: d3.toISOString(), checklist: {}, isDemo: true },
    { id: "j3", company: "Airwallex", role: "Product Manager ‚Äì Business Banking", roleType: "Product Manager", status: "saved", salary: "13,000 ‚Äì 17,000", priority: "Medium", url: "https://www.airwallex.com/careers", source: "Direct", notes: "‚ö†Ô∏è DEMO ‚Äî delete before use. In-house PM building B2B payments product.", dateApplied: d1.toISOString(), checklist: {}, isDemo: true }
  ]);
}
initSampleJobs();

function clearDemoData() {
  if (!confirm("Remove the 3 demo cards? Your real applications will stay.")) return;
  saveJobs(getJobs().filter(j => !j.isDemo));
  renderKanban(); updateStats(); renderAnalytics();
  toast("Demo cards removed ‚Äî the board is yours!", "success");
}

// ========== KANBAN ==========
let dragCard = null, dragJobId = null;

function renderKanban() {
  const jobs = getJobs();
  const board = document.getElementById("kanbanBoard");
  board.innerHTML = "";
  
  COLS.forEach(col => {
    const colJobs = jobs.filter(j => j.status === col);
    const div = document.createElement("div");
    div.className = "kanban-col";
    div.innerHTML = `
      <div class="kanban-col-header">
        <div style="display:flex;align-items:center;">
          <div class="col-dot" style="background:${COL_COLORS[col]};"></div>
          <span class="col-title">${COL_LABELS[col].replace(/[^\w\s]/g,"").trim()}</span>
        </div>
        <span class="col-count">${colJobs.length}</span>
      </div>
      <div class="kanban-drop-zone" data-col="${col}" id="drop-${col}">
        ${colJobs.map(j => renderCard(j)).join("")}
      </div>`;
    board.appendChild(div);
  });
  
  // Drag-drop
  document.querySelectorAll(".job-card[data-id]").forEach(card => {
    card.addEventListener("dragstart", e => { dragJobId = card.dataset.id; card.classList.add("dragging"); e.dataTransfer.effectAllowed = "move"; });
    card.addEventListener("dragend", () => { card.classList.remove("dragging"); document.querySelectorAll(".kanban-drop-zone").forEach(z => z.classList.remove("drag-over")); });
  });
  document.querySelectorAll(".kanban-drop-zone").forEach(zone => {
    zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("drag-over"); });
    zone.addEventListener("dragleave", () => zone.classList.remove("drag-over"));
    zone.addEventListener("drop", e => { e.preventDefault(); zone.classList.remove("drag-over"); if (dragJobId) { moveJob(dragJobId, zone.dataset.col); } });
  });
  
  updateFollowups();
}

function renderCard(j) {
  const days = daysSince(j.dateApplied);
  const needsFollowup = j.status === "applied" && days >= 7;
  const demoBanner = j.isDemo ? `<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:5px;padding:3px 8px;font-size:10px;font-weight:700;color:#c2410c;margin-bottom:6px;">‚ö†Ô∏è DEMO CARD ‚Äî click ‚úï to remove</div>` : "";
  return `<div class="job-card" draggable="true" data-id="${j.id}">
    ${demoBanner}
    <div class="flex-between">
      <div class="job-card-company">${j.company}</div>
      <button class="btn btn-xs btn-ghost" onclick="event.stopPropagation();deleteJob('${j.id}')" style="padding:2px 6px;font-size:10px;color:var(--gray-400);">‚úï</button>
    </div>
    <div class="job-card-role">${j.role} ¬∑ <span style="color:var(--blue);font-weight:600;">${j.roleType}</span></div>
    <div class="job-card-meta">
      <span class="meta-badge badge-${j.priority.toLowerCase()}">${j.priority}</span>
      ${j.salary ? `<span class="meta-badge badge-salary">S$${j.salary}</span>` : ""}
      <span class="meta-badge badge-days">${days}d</span>
      ${needsFollowup ? `<span class="meta-badge badge-followup">‚è∞ Follow up!</span>` : ""}
    </div>
    <div class="job-card-date">Applied: ${sgDate(j.dateApplied)} ¬∑ ${j.source || "Unknown source"}</div>
    ${j.notes ? `<div class="job-card-notes">${j.notes}</div>` : ""}
    ${j.jd ? `<div style="font-size:10px;color:var(--gray-400);margin:4px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${j.jd.substring(0,200)}">üìÑ ${j.jd.substring(0,80)}...</div>` : ""}
    <div class="job-card-actions">
      ${j.url ? `<a href="${j.url}" target="_blank" class="btn btn-xs btn-primary" style="text-decoration:none;">üîó Apply</a>` : '<span style="font-size:10px;color:var(--gray-400);">No link saved</span>'}
      <button class="btn btn-xs btn-secondary" onclick="openJobDetail('${j.id}')">üëÅ View</button>
      <button class="btn btn-xs btn-secondary" onclick="openApplyKitForJob('${j.id}')">‚ö° Kit</button>
      <button class="btn btn-xs btn-ghost" onclick="openChecklist('${j.id}')">‚òë List</button>
      <button class="btn btn-xs" style="background:#e0f2fe;color:#0369a1;border-radius:6px;border:none;cursor:pointer;padding:4px 8px;font-size:11px;font-weight:600;" onclick="quickMove('${j.id}','screen')">üìû</button>
      <button class="btn btn-xs" style="background:#ede9fe;color:#7c3aed;border-radius:6px;border:none;cursor:pointer;padding:4px 8px;font-size:11px;font-weight:600;" onclick="quickMove('${j.id}','interview')">üéôÔ∏è</button>
      <button class="btn btn-xs" style="background:#d1fae5;color:#065f46;border-radius:6px;border:none;cursor:pointer;padding:4px 8px;font-size:11px;font-weight:600;" onclick="quickMove('${j.id}','offer')">üèÜ</button>
    </div>
  </div>`;
}

function moveJob(id, newCol) {
  const jobs = getJobs();
  const j = jobs.find(j => j.id === id);
  if (j) { j.status = newCol; saveJobs(jobs); renderKanban(); updateStats(); toast(`Moved to ${COL_LABELS[newCol].replace(/[^\w\s]/g,"").trim()}`, "success"); }
}

function quickMove(id, col) { moveJob(id, col); }

function deleteJob(id) {
  if (!confirm("Delete this job card?")) return;
  const jobs = getJobs().filter(j => j.id !== id);
  saveJobs(jobs);
  renderKanban(); updateStats();
  toast("Job removed");
}

// ========== JOB DETAIL MODAL ==========
function openJobDetail(id) {
  const jobs = getJobs();
  const j = jobs.find(j => j.id === id);
  if (!j) return;

  document.getElementById("jdModalTitle").textContent = `üìã ${j.company} ‚Äî ${j.role}`;
  document.getElementById("jdModalCompany").textContent = j.company;
  document.getElementById("jdModalRole").textContent = `${j.role}${j.roleType ? " ¬∑ " + j.roleType : ""}`;

  // Badges
  const badgeColors = { High:"#fee2e2;color:#991b1b", Medium:"#fef3c7;color:#92400e", Low:"#f0fdf4;color:#166534" };
  const bc = badgeColors[j.priority] || "var(--gray-100);color:var(--gray-600)";
  document.getElementById("jdModalBadges").innerHTML = `
    <span style="background:${bc.split(";")[0]};color:${bc.split(";")[1]?.replace("color:","")};padding:2px 10px;border-radius:99px;font-size:11px;font-weight:700;">${j.priority || "‚Äî"}</span>
    ${j.status ? `<span style="background:var(--blue-pale);color:var(--blue);padding:2px 10px;border-radius:99px;font-size:11px;font-weight:700;">${j.status}</span>` : ""}
    ${j.salary ? `<span style="background:#f0fdf4;color:#166534;padding:2px 10px;border-radius:99px;font-size:11px;font-weight:700;">S$${j.salary}</span>` : ""}
    ${j.source ? `<span style="background:var(--gray-100);color:var(--gray-600);padding:2px 10px;border-radius:99px;font-size:11px;font-weight:600;">${j.source}</span>` : ""}`;

  // Apply URL
  if (j.url) {
    document.getElementById("jdModalApplyBtn").style.display = "inline-flex";
    document.getElementById("jdModalApplyBtn").href = j.url;
    document.getElementById("jdModalUrlRow").style.display = "block";
    document.getElementById("jdModalUrlText").value = j.url;
    document.getElementById("jdModalNoUrl").style.display = "none";
  } else {
    document.getElementById("jdModalApplyBtn").style.display = "none";
    document.getElementById("jdModalUrlRow").style.display = "none";
    document.getElementById("jdModalNoUrl").style.display = "block";
  }

  // JD
  const jdEl = document.getElementById("jdModalJD");
  if (j.jd && j.jd.trim()) {
    jdEl.textContent = j.jd;
    jdEl.style.color = "var(--gray-700)";
  } else {
    jdEl.textContent = "No job description captured. Use the LinkedIn bookmarklet to save jobs with their JD automatically.";
    jdEl.style.color = "var(--gray-400)";
  }

  // Kit button
  document.getElementById("jdModalKitBtn").onclick = () => { closeModal("jobDetailModal"); openApplyKitForJob(id); };

  openModal("jobDetailModal");
}

function copyJobUrl() {
  const url = document.getElementById("jdModalUrlText").value;
  if (!url) { toast("No URL to copy", "error"); return; }
  navigator.clipboard.writeText(url).then(() => toast("Apply link copied! üìã", "success"));
}

function copyJobJD() {
  const text = document.getElementById("jdModalJD").textContent;
  if (!text.trim()) { toast("No JD to copy", "error"); return; }
  navigator.clipboard.writeText(text).then(() => toast("JD copied! üìã", "success"));
}

function updateStats() {
  const jobs = getJobs();
  const total = jobs.filter(j => j.status !== "saved").length;
  const interviews = jobs.filter(j => j.status === "interview").length;
  const offers = jobs.filter(j => j.status === "offer").length;
  const applied = jobs.filter(j => ["applied","screen","interview","offer","rejected"].includes(j.status)).length;
  const rate = applied > 0 ? Math.round((interviews/applied)*100) : 0;
  document.getElementById("statTotal").textContent = total;
  document.getElementById("statInterviews").textContent = interviews;
  document.getElementById("statOffers").textContent = offers;
  document.getElementById("statRate").textContent = rate + "%";
}

function updateFollowups() {
  const jobs = getJobs().filter(j => j.status === "applied" && daysSince(j.dateApplied) >= 7);
  const el = document.getElementById("followupList");
  if (!jobs.length) { el.innerHTML = '<div style="color:var(--gray-400);font-size:12px;text-align:center;padding:20px;">No follow-ups needed üéâ</div>'; return; }
  el.innerHTML = jobs.map(j => `<div class="followup-item">
    <div class="followup-company">${j.company}</div>
    <div class="followup-role">${j.role}</div>
    <div class="followup-days">${daysSince(j.dateApplied)} days ¬∑ No response</div>
    <button class="btn btn-xs btn-secondary" style="margin-top:6px;" onclick="generateFollowUpForJob('${j.id}')">‚úâÔ∏è Write Follow-Up</button>
  </div>`).join("");
}

// ANALYTICS
function renderAnalytics() {
  const jobs = getJobs();
  // Funnel
  const stages = [
    { label: "Applied", col: ["applied","screen","interview","offer","rejected"], color: "#3b82f6" },
    { label: "Screened", col: ["screen","interview","offer"], color: "#f59e0b" },
    { label: "Interviewed", col: ["interview","offer"], color: "#8b5cf6" },
    { label: "Offered", col: ["offer"], color: "#10b981" }
  ];
  const total = jobs.length || 1;
  document.getElementById("funnelChart").innerHTML = stages.map(s => {
    const count = jobs.filter(j => s.col.includes(j.status)).length;
    const pct = Math.max(10, Math.round((count/total)*100));
    return `<div class="funnel-bar">
      <div class="funnel-label">${s.label} (${count})</div>
      <div class="funnel-track"><div class="funnel-fill" style="width:${pct}%;background:${s.color};">${count > 0 ? count : ""}</div></div>
    </div>`;
  }).join("");
  
  // Weekly (mock with stored data)
  const weeks = ["W1","W2","W3","W4","W5","W6"];
  const maxVal = Math.max(jobs.length, 5);
  const weekVals = weeks.map((_,i) => Math.max(0, Math.round(Math.random()*3)));
  weekVals[5] = jobs.filter(j => daysSince(j.dateApplied) < 7).length;
  document.getElementById("weeklyChart").innerHTML = weekVals.map((v,i) => {
    const h = Math.max(4, Math.round((v/maxVal)*80));
    return `<div class="chart-bar-wrap"><div class="chart-bar" style="height:${h}px;" title="${v} apps"></div><div class="chart-bar-label">${weeks[i]}</div></div>`;
  }).join("");
  
  // Source breakdown
  const sources = {};
  jobs.forEach(j => { sources[j.source||"Unknown"] = (sources[j.source||"Unknown"]||0)+1; });
  document.getElementById("sourceBreakdown").innerHTML = Object.entries(sources).map(([s,n]) => 
    `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px;">
      <div style="flex:1;">${s}</div>
      <div style="width:80px;height:6px;background:var(--gray-100);border-radius:99px;overflow:hidden;"><div style="width:${Math.round((n/total)*100)}%;height:100%;background:var(--blue);border-radius:99px;"></div></div>
      <div style="color:var(--gray-500);width:20px;text-align:right;">${n}</div>
    </div>`).join("") || '<div style="color:var(--gray-400);font-size:12px;">No data yet</div>';
}

// ========== JOB MODAL ==========
function openAddJobModal() {
  document.getElementById("mCompany").value="";document.getElementById("mRole").value="";
  document.getElementById("mUrl").value="";document.getElementById("mSalary").value="";
  document.getElementById("mNotes").value="";
  document.getElementById("addJobModal").style.display="flex";
}
function saveJob() {
  const company = document.getElementById("mCompany").value.trim();
  const role = document.getElementById("mRole").value.trim();
  if (!company||!role) { toast("Company and Role are required", "error"); return; }
  const jobs = getJobs();
  jobs.push({
    id: "j"+Date.now(),
    company, role,
    roleType: document.getElementById("mRoleType").value,
    status: document.getElementById("mStatus").value,
    url: document.getElementById("mUrl").value.trim(),
    salary: document.getElementById("mSalary").value.trim(),
    source: document.getElementById("mSource").value,
    priority: document.getElementById("mPriority").value,
    notes: document.getElementById("mNotes").value.trim(),
    dateApplied: new Date().toISOString(),
    checklist: {}
  });
  saveJobs(jobs);
  closeModal("addJobModal");
  renderKanban(); updateStats(); renderAnalytics();
  toast("Job added to tracker! üéâ", "success");
  incrementGoal();
}

// ========== CHECKLIST ==========
const CHECKLIST_ITEMS = [
  "Resume tailored for this JD",
  "Cover letter personalised",
  "LinkedIn profile updated to match",
  "Company researched on LinkedIn",
  "Hiring manager found on LinkedIn",
  "Application submitted",
  "Confirmation email received",
  "Follow-up reminder set (7 days)"
];
let currentChecklistJobId = null;

function openChecklist(jobId) {
  currentChecklistJobId = jobId;
  const jobs = getJobs();
  const j = jobs.find(j => j.id === jobId);
  document.getElementById("checklistTitle").textContent = `‚úÖ Application Checklist ‚Äì ${j?.company||""}`;
  const checked = j?.checklist || {};
  document.getElementById("checklistItems").innerHTML = CHECKLIST_ITEMS.map((item, i) => 
    `<div class="checklist-item ${checked[i] ? 'done' : ''}">
      <input type="checkbox" id="cli${i}" ${checked[i]?'checked':''} onchange="toggleChecklist(${i})">
      <label for="cli${i}">${item}</label>
    </div>`).join("");
  document.getElementById("checklistModal").style.display="flex";
}
function toggleChecklist(idx) {
  const jobs = getJobs();
  const j = jobs.find(j => j.id === currentChecklistJobId);
  if (!j) return;
  if (!j.checklist) j.checklist = {};
  j.checklist[idx] = document.getElementById("cli"+idx).checked;
  const item = document.getElementById("cli"+idx).closest(".checklist-item");
  if (j.checklist[idx]) item.classList.add("done"); else item.classList.remove("done");
  saveJobs(jobs);
}
function saveChecklist() { toast("Checklist saved!", "success"); closeModal("checklistModal"); }

// ========== APPLY KIT FOR JOB ==========
async function openApplyKitForJob(jobId) {
  const jobs = getJobs();
  const j = jobs.find(j => j.id === jobId);
  if (!j) return;
  
  document.getElementById("applyKitTitle").textContent = `‚ö° Apply Kit ‚Äì ${j.company} ¬∑ ${j.role}`;
  document.getElementById("applyKitContent").innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;"><span class="spinner spinner-blue" style="width:32px;height:32px;border-width:3px;"></span><div style="margin-top:12px;color:var(--gray-400);">Generating kit for '+j.company+'...</div></div>';
  document.getElementById("applyKitModal").style.display="flex";
  
  const jd = j.notes || `${j.role} at ${j.company}`;
  const resumePromise = callClaude(`Write an ATS-optimised resume for ${PROFILE.name} applying to ${j.role} at ${j.company}. Role type: ${j.roleType}. Use this candidate data: ${JSON.stringify({summary:PROFILE.summary,skills:PROFILE.skills,experience:PROFILE.experience,education:PROFILE.education,certification:PROFILE.certification})}. Context: ${jd}. Include all sections, be specific with metrics.`);
  const coverPromise = callClaude(`Write a 300-word cover letter for ${PROFILE.name} applying to ${j.role} at ${j.company}. Highlight: 5% KPMG profit increase, 30 man-days saved, SAFe 6.0 certified. Professional and specific to ${j.company}.`);
  
  try {
    const [resume, cover] = await Promise.all([resumePromise, coverPromise]);

    document.getElementById("applyKitContent").innerHTML = `
      <div class="panel-box">
        <div class="panel-header">üìÑ Tailored Resume</div>
        <div class="panel-body" id="akResume" style="max-height:400px;overflow-y:auto;">${resume}</div>
        <div class="panel-footer"><button class="btn btn-sm btn-secondary" onclick="copyPanel('akResume')">üìã Copy</button><button class="btn btn-sm btn-ghost" onclick="downloadOutput('akResume','resume_${j.company}.txt')">‚¨á Download</button></div>
      </div>
      <div class="panel-box">
        <div class="panel-header">‚úâÔ∏è Cover Letter</div>
        <div class="panel-body" id="akCover" style="max-height:400px;overflow-y:auto;">${cover}</div>
        <div class="panel-footer"><button class="btn btn-sm btn-secondary" onclick="copyPanel('akCover')">üìã Copy</button><button class="btn btn-sm btn-ghost" onclick="downloadOutput('akCover','cover_${j.company}.txt')">‚¨á Download</button></div>
      </div>`;
    toast("Kit ready!", "success");
  } catch(e) {
    document.getElementById("applyKitContent").innerHTML = `<div style="grid-column:1/-1;padding:20px;color:red;">Error: ${e.message}</div>`;
  }
}

// ========== FOLLOW-UP GENERATOR ==========
async function generateFollowUpForJob(jobId) {
  const jobs = getJobs();
  const j = jobs.find(j => j.id === jobId);
  if (!j) return;
  switchTab("tab5", document.querySelector('.tab-btn:nth-child(5)'));
  document.getElementById("fuCompany").value = j.company;
  document.getElementById("fuRole").value = j.role;
  document.getElementById("fuDays").value = daysSince(j.dateApplied);
  await generateFollowUp();
}

async function generateFollowUp() {
  const company = document.getElementById("fuCompany").value.trim() || "the company";
  const role = document.getElementById("fuRole").value.trim() || "the role";
  const days = document.getElementById("fuDays").value || "7";
  document.getElementById("followUpOutput").innerHTML = '<span class="spinner spinner-blue"></span>';
  try {
    const data = await callBackend("/api/follow-up", { company, role, days });
    document.getElementById("followUpOutput").textContent = data.result;
    document.getElementById("copyFuBtn").style.display = "inline-flex";
    toast("Follow-up email ready!", "success");
  } catch(e) {
    document.getElementById("followUpOutput").textContent = "Error: " + e.message;
  }
}

// ========== EXPORT CSV ==========
function exportCSV() {
  const jobs = getJobs();
  const headers = ["Company","Role","Role Type","Status","Priority","Salary","Source","Date Applied","Days Since","URL","Notes"];
  const rows = jobs.map(j => [j.company,j.role,j.roleType,j.status,j.priority,j.salary,j.source,sgDate(j.dateApplied),daysSince(j.dateApplied),j.url,j.notes].map(v => `"${(v||"").toString().replace(/"/g,'""')}"`));
  const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "job_applications.csv"; a.click();
  toast("CSV exported!", "success");
}

// ========== PRODUCT FRAMING CONTEXT ==========
const PRODUCT_FRAMING = `
CRITICAL POSITIONING ‚Äî She is transitioning from CONSULTING/SERVICE delivery to IN-HOUSE PRODUCT roles:
- Reframe "KPMG consultant" ‚Üí "Product Owner for Loan IQ product squad"
- Reframe "client delivery" ‚Üí "shipped product features, owned backlog, drove sprint outcomes"
- Reframe "5% project profit" ‚Üí "drove ~5% business value through product scope decisions"
- Reframe "saved 30 man-days" ‚Üí "identified automation opportunity, drove product feature that eliminated 30 man-days of manual work"
- DO NOT use: consultant, client, engagement, billable, service delivery, account
- DO USE: product, squad, roadmap, discovery, iteration, user value, outcome, feature, backlog, sprint, release
`;

// ========== QUICK APPLY SPEED KIT ==========
const SPEED_KIT_QA = [
  { icon:"üë§", field:"About You", q:"Tell us about yourself / Walk me through your background",
    a:`I'm Amretha Karthikeyan, a SAFe 6.0 certified Product Owner and Lead Business Analyst with 5+ years owning product backlogs in fintech and banking. At KPMG Singapore, I was the de-facto Product Owner for Loan IQ ‚Äî a core banking platform ‚Äî leading cross-functional squads to ship features used by enterprise banks. Outside of work, I independently built and deployed a live AI-powered Trade Analysis platform using Claude Opus 4.6 ‚Äî it combines financial trade data and international trade flow analysis and is live at https://stock-monitor-8ak6.onrender.com. It reflects my genuine interest in building with AI, not just talking about it. I'm now looking for an in-house product role where I can own the roadmap end-to-end and drive measurable outcomes.`},
  { icon:"üîÑ", field:"Agile / SAFe Experience", q:"Describe your Agile or SAFe experience",
    a:`I hold a SAFe 6.0 Product Owner/Product Manager certification and practised it daily at KPMG on the Loan IQ product programme. I led all sprint ceremonies ‚Äî planning, reviews, retrospectives, PI Planning ‚Äî for a cross-functional squad. I wrote user stories with clear acceptance criteria, groomed and prioritised the product backlog using RICE and value-vs-risk frameworks, and managed cross-team dependencies across a multi-squad programme. I'm comfortable working in both SAFe and standard Scrum environments.`},
  { icon:"üèÜ", field:"Greatest Achievement", q:"What is your greatest professional achievement?",
    a:`At KPMG, I identified that a critical interest computation process was being handled manually, creating significant rework every sprint. I analysed the root cause, designed an automated product solution with the engineering team, and drove it to delivery ‚Äî saving 30 man-days of effort. Separately, I used impact analysis to build a business case for a set of change requests the client initially rejected, and secured sign-off ‚Äî generating approximately 5% additional business value. Both came from proactively finding problems before they became blockers.`},
  { icon:"üìã", field:"Prioritisation Approach", q:"How do you prioritise a product backlog?",
    a:`I use RICE scoring (Reach, Impact, Confidence, Effort) as a baseline and layer in strategic alignment, regulatory requirements, and user pain severity. I always involve the engineering lead in effort estimation to keep prioritisation grounded in reality. On Loan IQ, I also factored in hard compliance deadlines as non-negotiable constraints. I hold regular backlog refinement sessions to ensure the top of the backlog is always 2‚Äì3 sprints ahead in detail, and I use sprint reviews to re-calibrate priorities based on real user and stakeholder feedback.`},
  { icon:"ü§ù", field:"Influencing Without Authority", q:"Describe a time you influenced stakeholders without authority",
    a:`At KPMG, a set of product change requests were blocked by the client's steering committee who saw them as scope creep. Rather than escalating, I prepared a concise impact analysis mapping each change to a specific business risk or missed revenue opportunity ‚Äî in their language, not technical language. I presented it in a working session directly to their finance leads. Every change request was approved, contributing ~5% to the programme's business value. The key was reframing technical decisions as business outcomes the stakeholders already cared about.`},
  { icon:"üí∞", field:"Salary Expectations", q:"What are your salary expectations?",
    a:`Based on my 5+ years of experience, SAFe 6.0 certification, and the Singapore market for senior Product Owners and PMs in fintech, I'm targeting S$10,000‚Äì13,000/month. I'm happy to discuss the full package including equity, performance bonus, and learning budget.`},
  { icon:"üö™", field:"Why Leaving / Transition", q:"Why are you leaving consulting / why move in-house?",
    a:`I've had a strong run at KPMG and I'm proud of what I built on the Loan IQ programme. The reason I'm moving in-house is simple: I want to own a product roadmap for long enough to see whether my decisions were right. In consulting, you ship and move on. In-house, you live with your choices, learn from real users, and compound your product intuition over time. I want to build, not just deliver ‚Äî and I want to be accountable for the outcomes, not just the outputs.`},
  { icon:"‚ö°", field:"Strengths", q:"What are your key strengths as a Product person?",
    a:`Three things: First, I bridge business and engineering fluently ‚Äî I've sat in both worlds and I know how to translate user problems into engineering requirements without losing meaning. Second, I'm metrics-driven ‚Äî I measure everything I ship against the outcome it was supposed to drive. Third, I influence without authority ‚Äî the best example is getting blocked change requests approved at KPMG by reframing them in stakeholder language, which added ~5% business value to the programme.`}
];

async function openSpeedKit() {
  const company = document.getElementById("kitCompany").value.trim() || "the company";
  const role = document.getElementById("kitRole").value.trim() || "this role";
  document.getElementById("speedKitModal").style.display = "flex";
  document.getElementById("speedKitContent").innerHTML = `<div style="text-align:center;padding:30px;"><span class="spinner spinner-blue" style="width:28px;height:28px;border-width:3px;"></span><div style="margin-top:12px;color:var(--gray-400);">Personalising your answers for ${company}...</div></div>`;
  
  let motivationA = `I'm drawn to ${company} because of the scale and impact of what you're building. My background owning the Loan IQ product backlog at KPMG ‚Äî shipping core banking features used by enterprise banks ‚Äî maps closely to the complexity and domain here. More importantly, I want to transition from delivering for clients to building for users directly, and ${company} is exactly the in-house product environment where I can do that.`;
  try {
    const motData = await callBackend('/api/speed-kit', { company, role }); motivationA = motData.result; 
  } catch(e) {}
  
  const qaWithMotivation = [
    { icon:"üí°", field:"Why This Company", q:"Why do you want to work here?", a: motivationA },
    ...SPEED_KIT_QA
  ];
  
  document.getElementById("speedKitContent").innerHTML = qaWithMotivation.map((item, i) => `
    <div style="border:1.5px solid var(--gray-200);border-radius:10px;margin-bottom:12px;overflow:hidden;">
      <div style="background:var(--gray-50);padding:10px 14px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;gap:8px;">
        <span style="font-size:15px;">${item.icon}</span>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:12px;color:var(--navy);">${item.field}</div>
          <div style="font-size:11px;color:var(--gray-400);font-style:italic;">"${item.q}"</div>
        </div>
        <button class="btn btn-xs btn-secondary" onclick="copySpeedAns('ska${i}')">üìã Copy</button>
      </div>
      <div id="ska${i}" style="padding:12px 14px;font-size:13px;line-height:1.65;color:var(--gray-700);">${item.a}</div>
    </div>`).join("");
  toast("Speed kit ready! Copy answers and apply in under 3 mins üöÄ", "success");
}
function copySpeedAns(id) {
  navigator.clipboard.writeText(document.getElementById(id).textContent).then(()=>toast("Copied to clipboard! üìã","success"));
}

// ========== AUTO-APPLY COMMAND CENTRE ==========
const TARGET_COMPANIES = [
  {name:"Grab",url:"https://grab.careers"},{name:"Sea Limited",url:"https://careers.sea.com"},{name:"Shopee",url:"https://careers.shopee.sg"},
  {name:"DBS Bank",url:"https://www.dbs.com/careers"},{name:"GovTech",url:"https://careers.govtech.gov.sg"},{name:"Stripe",url:"https://stripe.com/jobs"},
  {name:"Airwallex",url:"https://www.airwallex.com/careers"},{name:"Nium",url:"https://www.nium.com/company/careers"},{name:"PropertyGuru",url:"https://www.propertyguru.com.sg/careers"},
  {name:"Carousell",url:"https://careers.carousell.com"},{name:"Circles.Life",url:"https://www.circles.life/sg/careers"},{name:"OCBC",url:"https://www.ocbc.com/careers"},
  {name:"Singtel",url:"https://careers.singtel.com"},{name:"Funding Societies",url:"https://fundingsocieties.com/careers"},{name:"Aspire",url:"https://aspire.io/careers"}
];

function renderTargetCompanies() {
  const role = document.getElementById("searchRoleType")?.value || "Product Owner";
  const productCos = [
    {name:"Grab",tag:"Super App",url:"https://grab.careers"},
    {name:"Sea / Shopee",tag:"E-commerce",url:"https://careers.sea.com"},
    {name:"Airwallex",tag:"Fintech",url:"https://www.airwallex.com/careers"},
    {name:"Nium",tag:"Payments",url:"https://www.nium.com/company/careers"},
    {name:"Stripe",tag:"Payments",url:"https://stripe.com/jobs"},
    {name:"GovTech",tag:"Gov Product",url:"https://careers.govtech.gov.sg"},
    {name:"Carousell",tag:"Marketplace",url:"https://careers.carousell.com"},
    {name:"PropertyGuru",tag:"PropTech",url:"https://www.propertyguru.com.sg/careers"},
    {name:"Funding Societies",tag:"Fintech",url:"https://fundingsocieties.com/careers"},
    {name:"Aspire",tag:"B2B Fintech",url:"https://aspire.io/careers"},
    {name:"Circles.Life",tag:"Telecom",url:"https://www.circles.life/sg/careers"},
    {name:"DBS / digibank",tag:"Banking",url:"https://www.dbs.com/careers"},
    {name:"Lazada",tag:"E-commerce",url:"https://careers.lazada.sg"},
    {name:"TikTok SG",tag:"Tech",url:"https://careers.tiktok.com"},
    {name:"Singtel",tag:"Telco",url:"https://careers.singtel.com"}
  ];
  document.getElementById("targetCompanies").innerHTML = productCos.map(c => 
    `<a class="company-chip" href="https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(role + " " + c.tag)}&location=Singapore" target="_blank" rel="noopener" title="Search ${role} at ${c.name}">
      üè¢ ${c.name} <span style="opacity:0.6;font-size:10px;">${c.tag}</span>
    </a>`).join("");
}

function launchJobSearch() {
  const role = document.getElementById("searchRoleType").value;
  const loc = document.getElementById("searchLocation").value || "Singapore";
  const exp = document.getElementById("searchExp").value;
  const salMin = document.getElementById("searchSalMin").value || "";
  const kw = document.getElementById("searchKeywords").value;
  const q = encodeURIComponent([role, kw, exp, "Singapore"].filter(Boolean).join(" "));
  
  const boards = [
    `https://www.linkedin.com/jobs/search/?keywords=${q}&location=${encodeURIComponent(loc)}&f_E=4`,
    `https://sg.indeed.com/jobs?q=${q}&l=${encodeURIComponent(loc)}`,
    `https://www.glassdoor.sg/Job/singapore-${encodeURIComponent(role.toLowerCase())}-jobs-SRCH_IL.0,9_IC3235921_KO10,${10+role.length}.htm`,
    `https://nodeflair.com/jobs?query=${q}`,
    `https://www.jobstreet.com.sg/${encodeURIComponent(role.toLowerCase().replace(/ /g,"-"))}-jobs`
  ];
  
  boards.forEach(url => window.open(url, "_blank"));
  toast("Opening all job boards!", "success");
}

function openBoard(board) {
  const role = document.getElementById("searchRoleType")?.value || "Business Analyst";
  const q = encodeURIComponent(role + " Singapore");
  const urls = {
    linkedin: `https://www.linkedin.com/jobs/search/?keywords=${q}&location=Singapore`,
    indeed: `https://sg.indeed.com/jobs?q=${q}&l=Singapore`,
    glassdoor: `https://www.glassdoor.sg/Job/singapore-jobs-SRCH_IL.0,9_IC3235921.htm`,
    nodeflair: `https://nodeflair.com/jobs?query=${q}`,
    jobstreet: `https://www.jobstreet.com.sg/jobs?q=${encodeURIComponent(role)}&l=Singapore`
  };
  if (urls[board]) window.open(urls[board], "_blank");
}

// Application Kit Generator
let kitData = { company:"", role:"", roleType:"", jd:"" };

async function generateFullKit() {
  const company = document.getElementById("kitCompany").value.trim();
  const role = document.getElementById("kitRole").value.trim();
  const roleType = document.getElementById("kitRoleType").value;
  const jd = document.getElementById("kitJD").value.trim();
  if (!company || !role) { toast("Please enter Company and Role", "error"); return; }
  kitData = { company, role, roleType, jd };
  const btn = document.getElementById("kitBtn");
  btn.innerHTML = '<span class="spinner"></span> Generating...';
  btn.disabled = true;
  document.getElementById("kitOutputSection").style.display = "block";
  ["kitResume","kitCover","kitPrep"].forEach(id => { document.getElementById(id).textContent = "Generating..."; });
  try {
    const data = await callBackend("/api/full-kit", { company, role, roleType, jd });
    document.getElementById("kitResume").textContent = data.resume;
    document.getElementById("kitCover").textContent = data.cover;
    document.getElementById("kitPrep").textContent = data.prep;
    const { score } = analyzeKeywords(jd || role, roleType);
    const scoreEl = document.getElementById("kitKwScore");
    scoreEl.textContent = `${score}/100`;
    scoreEl.className = `score-badge ${score>=70?"score-high":score>=40?"score-mid":"score-low"}`;
    toast("Full application kit ready! üéâ", "success");
  } catch(e) {
    document.getElementById("kitResume").textContent = "Error: " + e.message;
    toast("Error: " + e.message, "error");
  }
  btn.innerHTML = "‚ö° Generate Full Application Kit";
  btn.disabled = false;
}

function logApplicationFromKit() {
  const company = document.getElementById("kitCompany").value.trim();
  const role = document.getElementById("kitRole").value.trim();
  if (!company || !role) { toast("Generate a kit first", "error"); return; }
  const jobs = getJobs();
  jobs.push({ id:"j"+Date.now(), company, role, roleType: document.getElementById("kitRoleType").value, status:"applied", salary:"", source:"Direct", priority:"High", notes:"Added from Application Kit Generator", url:"", dateApplied: new Date().toISOString(), checklist:{} });
  saveJobs(jobs);
  toast(`${company} logged to tracker! ‚úÖ`, "success");
  incrementGoal();
}

function copyPanel(elId) {
  const el = document.getElementById(elId);
  navigator.clipboard.writeText(el.textContent || el.innerText).then(() => toast("Copied to clipboard! üìã", "success"));
}

// ========== SALARY BENCHMARKING ==========
const SALARY_DATA = [
  { role: "Product Manager", min: 8000, max: 14000 },
  { role: "Product Owner", min: 7500, max: 12000 },
  { role: "Business Analyst Lead", min: 7000, max: 11000 },
  { role: "Business Development", min: 6000, max: 12000 }
];

function renderSalaryBars() {
  const globalMax = 16000;
  document.getElementById("salaryBars").innerHTML = SALARY_DATA.map(s => `
    <div class="salary-bar-wrap">
      <div class="salary-role">${s.role}</div>
      <div class="salary-range-bar">
        <div class="salary-fill" style="left:${(s.min/globalMax)*100}%;width:${((s.max-s.min)/globalMax)*100}%;"></div>
        <div id="targetMark_${s.role.replace(/\s/g,'_')}" class="target-marker" style="display:none;"></div>
      </div>
      <div class="salary-numbers">S$${s.min.toLocaleString()} ‚Äì S$${s.max.toLocaleString()}</div>
    </div>`).join("");
}

function checkSalaryPosition() {
  const target = parseInt(document.getElementById("myTargetSalary").value);
  if (!target) { document.getElementById("salaryPositionMsg").innerHTML=""; return; }
  const globalMax = 16000;
  const myRole = SALARY_DATA[2]; // BA Lead
  const pct = (target / globalMax) * 100;
  
  SALARY_DATA.forEach(s => {
    const mark = document.getElementById("targetMark_"+s.role.replace(/\s/g,'_'));
    if (mark) { mark.style.left = pct + "%"; mark.style.display = "block"; }
  });
  
  let msg = "";
  if (target < myRole.min) msg = `<div style="background:#fee2e2;border:1.5px solid #fca5a5;border-radius:8px;padding:10px;font-size:12px;color:#991b1b;">‚¨á Your target of S$${target.toLocaleString()} is <strong>below market</strong> for BA Lead (S$${myRole.min.toLocaleString()}‚ÄìS$${myRole.max.toLocaleString()}). Consider anchoring higher!</div>`;
  else if (target > myRole.max) msg = `<div style="background:#fef3c7;border:1.5px solid #fcd34d;border-radius:8px;padding:10px;font-size:12px;color:#92400e;">‚¨Ü Your target is <strong>above market median</strong> ‚Äî this is achievable with your SAFe cert and KPMG track record.</div>`;
  else msg = `<div style="background:#dcfce7;border:1.5px solid #86efac;border-radius:8px;padding:10px;font-size:12px;color:#166534;">‚úÖ S$${target.toLocaleString()} is <strong>within market range</strong> for BA Lead. With your metrics, aim for the upper end!</div>`;
  
  document.getElementById("salaryPositionMsg").innerHTML = msg;
}

// ========== REFERRALS ==========
function getReferrals() { return JSON.parse(localStorage.getItem("referrals") || "[]"); }
function saveReferrals(r) { localStorage.setItem("referrals", JSON.stringify(r)); }

function openReferralModal() {
  ["rName","rCompany","rRole","rLinkedIn","rNotes"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("rStatus").value = "Not Contacted";
  document.getElementById("referralModal").style.display = "flex";
}

function saveReferral() {
  const name = document.getElementById("rName").value.trim();
  if (!name) { toast("Name is required", "error"); return; }
  const refs = getReferrals();
  refs.push({ id:"r"+Date.now(), name, company: document.getElementById("rCompany").value.trim(), role: document.getElementById("rRole").value.trim(), linkedin: document.getElementById("rLinkedIn").value.trim(), status: document.getElementById("rStatus").value, notes: document.getElementById("rNotes").value.trim(), dateContacted: new Date().toISOString() });
  saveReferrals(refs);
  closeModal("referralModal");
  renderReferrals();
  toast("Referral contact saved!", "success");
}

function renderReferrals() {
  const refs = getReferrals();
  const el = document.getElementById("referralList");
  if (!refs.length) { el.innerHTML = '<div style="color:var(--gray-400);font-size:12px;text-align:center;padding:30px;">No referral contacts yet.</div>'; return; }
  const statusColors = {"Not Contacted":"#f3f4f6","Reached Out":"#dbeafe","In Discussion":"#fef3c7","Referred":"#dcfce7","No Response":"#fee2e2"};
  el.innerHTML = refs.map(r => `<div class="referral-row">
    <div>
      <div class="referral-name">${r.name}</div>
      <div class="referral-co">${r.company} ¬∑ ${r.role}</div>
    </div>
    <span style="background:${statusColors[r.status]||'#f3f4f6'};padding:3px 10px;border-radius:99px;font-size:11px;font-weight:600;">${r.status}</span>
    ${r.linkedin ? `<a href="${r.linkedin}" target="_blank" class="btn btn-xs btn-secondary">üîó LinkedIn</a>` : ""}
    <button class="btn btn-xs btn-ghost" onclick="deleteReferral('${r.id}')">‚úï</button>
  </div>`).join("");
}

function deleteReferral(id) {
  saveReferrals(getReferrals().filter(r => r.id !== id));
  renderReferrals(); toast("Removed");
}

// ========== UTILITIES ==========
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }

function downloadOutput(elId, filename) {
  const text = document.getElementById(elId).textContent;
  if (!text.trim()) { toast("Nothing to download", "error"); return; }
  const blob = new Blob([text], {type:"text/plain"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  toast("Downloaded!", "success");
}

// Close modals on overlay click
document.querySelectorAll(".modal-overlay").forEach(overlay => {
  overlay.addEventListener("click", e => { if (e.target === overlay) overlay.style.display = "none"; });
});

// ========== INIT ==========
renderKanban();
updateStats();
renderAnalytics();
renderTargetCompanies();
renderSalaryBars();
renderReferrals();

// Set daily goal from storage
const savedGoal = localStorage.getItem("dailyGoalTarget");
if (savedGoal) document.getElementById("dailyGoalTarget").value = savedGoal;
document.getElementById("dailyGoalTarget").addEventListener("change", function() { localStorage.setItem("dailyGoalTarget", this.value); updateGoalDisplay(); });

// API handled server-side ‚Äî no client key needed

// ‚îÄ‚îÄ‚îÄ BOOKMARKLET SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyBookmarklet() {
  var appUrl = window.location.origin;

  var code = 'javascript:void(async function(){'
    + 'var u=location.href;'

    // ‚îÄ‚îÄ BULK MODE ‚Äî LinkedIn Saved Jobs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    + 'if(u.indexOf("my-items")>-1||u.indexOf("saved-jobs")>-1){'

      // ‚îÄ‚îÄ UI overlay ‚îÄ‚îÄ
      + 'var ov=document.createElement("div");'
      + 'ov.id="jt-ov";'
      + 'ov.style="position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:99998;display:flex;align-items:center;justify-content:center;font-family:-apple-system,sans-serif;";'
      + 'ov.innerHTML=\'<div style="background:white;border-radius:16px;padding:32px 40px;max-width:380px;width:90%;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,0.3);">'
        + '<div style="font-size:36px;margin-bottom:12px;">üîç</div>'
        + '<div style="font-size:18px;font-weight:700;color:#0a66c2;margin-bottom:8px;">Scanning Saved Jobs</div>'
        + '<div id="jt-msg" style="font-size:13px;color:#555;margin-bottom:16px;">Scrolling to load all jobs...</div>'
        + '<div style="background:#e8f0fe;border-radius:8px;height:8px;overflow:hidden;">'
          + '<div id="jt-bar" style="background:#0a66c2;height:100%;width:0%;transition:width 0.3s;border-radius:8px;"></div>'
        + '</div>'
        + '<div id="jt-count" style="font-size:12px;color:#888;margin-top:8px;">0 jobs found so far</div>'
      + '</div>\';'
      + 'document.body.appendChild(ov);'
      + 'var msg=document.getElementById("jt-msg");'
      + 'var bar=document.getElementById("jt-bar");'
      + 'var cnt=document.getElementById("jt-count");'

      // ‚îÄ‚îÄ Collect jobs from live DOM ‚îÄ‚îÄ
      + 'function collectJobs(seen){'
        + 'var jobs=[];'
        + 'document.querySelectorAll("a[href*=\'/jobs/view/\']").forEach(function(a){'
          + 'var href=a.href.split("?")[0];if(!href||seen[href])return;seen[href]=true;'
          + 'var card=a.closest("li,article,[data-occludable-job-id],[class*=job-card]")||a.parentElement;'
          + 'var t="",c="";'
          + 'var lbl=(a.getAttribute("aria-label")||"").trim();'
          + 'if(lbl.length>2){t=lbl;}'
          + 'if(!t){'
            + 'var titleTry=["[class*=job-card-list__title]","[class*=job-card__title]","[class*=artdeco-entity-lockup__title]","strong","h3","h2"];'
            + 'for(var i=0;i<titleTry.length;i++){var el=card.querySelector(titleTry[i]);if(el&&el.innerText.trim().length>2){t=el.innerText.trim();break;}}'
          + '}'
          + 'var coTry=["[class*=primary-description]","[class*=artdeco-entity-lockup__subtitle]","[class*=job-card__company]","[class*=company-name]","[class*=subtitle]","h4"];'
          + 'for(var i=0;i<coTry.length;i++){var el=card.querySelector(coTry[i]);if(el&&el.innerText.trim().length>2){c=el.innerText.trim();break;}}'
          + 'if(t&&!c){var ai=t.lastIndexOf(" at ");if(ai>-1){c=t.substring(ai+4).trim();t=t.substring(0,ai).trim();}}'
          + 'if(t.length>2)jobs.push({role:t,company:c||"Unknown",location:"Singapore",url:href,jd:"",status:"wishlist"});'
        + '});'
        + 'return jobs;'
      + '}'

      // ‚îÄ‚îÄ Auto-scroll to trigger LinkedIn lazy loading ‚îÄ‚îÄ
      + 'var seen={};var allJobs=[];var lastCount=0;var noNewRounds=0;'
      + 'var scrollEl=document.querySelector(".scaffold-layout__list,.jobs-search-results-list,[class*=scaffold-layout__list]")||document.documentElement;'

      + 'for(var round=0;round<60;round++){'
        // Scroll down in chunks
        + 'scrollEl.scrollTop+=600;window.scrollBy(0,600);'
        + 'await new Promise(function(r){setTimeout(r,600);});'

        // Collect newly visible jobs
        + 'var fresh=collectJobs(seen);'
        + 'allJobs=allJobs.concat(fresh);'

        // Update UI
        + 'var pct=Math.min(95,Math.round((round/50)*100));'
        + 'bar.style.width=pct+"%";'
        + 'cnt.textContent=allJobs.length+" jobs found so far";'
        + 'msg.textContent="Scrolling to load all jobs... (pass "+(round+1)+")";'

        // Stop if no new jobs found for 5 consecutive rounds
        + 'if(allJobs.length===lastCount){noNewRounds++;}else{noNewRounds=0;lastCount=allJobs.length;}'
        + 'if(noNewRounds>=5&&allJobs.length>0)break;'
      + '}'

      + 'bar.style.width="100%";'
      + 'ov.remove();'

      + 'if(!allJobs.length){alert("No saved jobs found.\\n\\nTips:\\n‚Ä¢ Make sure you are on: linkedin.com/my-items/saved-jobs/\\n‚Ä¢ Wait for the page to fully load before clicking\\n‚Ä¢ Try scrolling down manually first");return;}'
      + 'if(!confirm("Found "+allJobs.length+" saved job(s)!\\nAdd all to Job Tracker?"))return;'
      + 'var f=document.createElement("form");f.method="POST";f.action="' + appUrl + '/capture-bulk";'
      + 'var inp=document.createElement("input");inp.type="hidden";inp.name="jobs";inp.value=JSON.stringify(allJobs);'
      + 'f.appendChild(inp);document.body.appendChild(f);f.submit();'
      + 'return;'
    + '}'

    // ‚îÄ‚îÄ SINGLE MODE ‚Äî individual job listing page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    + 'var t="",c="",l="Singapore",jd="";'
    + 'var pt=document.title.replace(/\\s*[|]\\s*LinkedIn.*/i,"").replace(/\\s*-\\s*LinkedIn.*/i,"").trim();'
    + 'var ai=pt.lastIndexOf(" at ");'
    + 'if(ai>-1){t=pt.substring(0,ai).trim();c=pt.substring(ai+4).trim();}else{t=pt.trim();}'
    + 'var ts=["h1[class*=job-title]","h1[class*=title]","[class*=job-details-jobs-unified-top-card__job-title] h1",".top-card-layout__title","h1.t-24","h1.t-bold","h1"];'
    + 'for(var i=0;i<ts.length;i++){var el=document.querySelector(ts[i]);if(el&&el.innerText.trim().length>2){t=el.innerText.trim();break;}}'
    + 'var cs=["[class*=job-details-jobs-unified-top-card__company-name] a","[class*=job-details-jobs-unified-top-card__company-name]",".topcard__org-name-link","[class*=company-name] a","[class*=company-name]","[class*=employer-name]"];'
    + 'for(var i=0;i<cs.length;i++){var el=document.querySelector(cs[i]);if(el&&el.innerText.trim().length>2){c=el.innerText.trim();break;}}'
    + 'var ls=["[class*=job-details-jobs-unified-top-card__bullet]","[class*=workplace-type]","[class*=job-insight]"];'
    + 'for(var i=0;i<ls.length;i++){var el=document.querySelector(ls[i]);if(el&&el.innerText.trim().length>2){l=el.innerText.trim();break;}}'
    + 'var ds=["[class*=jobs-description__content]","[class*=jobs-box__html-content]","[class*=description__content]","[class*=description]"];'
    + 'for(var i=0;i<ds.length;i++){var el=document.querySelector(ds[i]);if(el&&el.innerText.trim().length>50){jd=el.innerText.trim().substring(0,4000);break;}}'
    + 'if(!t||t.length<2){alert("Could not detect job title. Wait for the page to fully load.");return;}'
    + 'if(!confirm("Add to Job Tracker?\\n\\nRole: "+t+"\\nCompany: "+(c||"Unknown")+"\\n"+(jd?"\\u2705 JD captured":"\\u26a0\\ufe0f No JD found")))return;'
    + 'location.href="' + appUrl + '/capture?title="+encodeURIComponent(t)+"&company="+encodeURIComponent(c||"Unknown")+"&location="+encodeURIComponent(l)+"&jd="+encodeURIComponent(jd)+"&url="+encodeURIComponent(u.split("?")[0]);'
  + '}())';

  var box = document.getElementById('bookmarkletBox');
  if (box) { box.value = code; box.select(); }
}
// ‚îÄ‚îÄ‚îÄ POLL FOR BOOKMARKLET JOBS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkBookmarkletJobs() {
  try {
    const data = await callBackend('/api/bookmarklet-jobs', {});
    // callBackend uses POST - let's use fetch directly for this GET
  } catch(e) {}
}

// Poll via GET every 30 seconds when tab3 is visible
async function pollBookmarkletJobs() {
  try {
    const res = await fetch('/api/bookmarklet-jobs');
    const data = await res.json();
    if (data.jobs && data.jobs.length > 0) {
      data.jobs.forEach(j => {
        // Only add if not already in tracker
        if (!jobs.find(existing => existing.url === j.url && existing.company === j.company)) {
          jobs.push(j);
        }
      });
      saveJobs(jobs);
      renderKanban();
      updateStats();
      toast(`üîñ ${data.jobs.length} job(s) added from bookmarklet!`, 'success');
    }
  } catch(e) {}
}
// Poll every 30 seconds
setInterval(pollBookmarkletJobs, 30000);
// Also poll immediately on load
pollBookmarkletJobs();

console.log("üöÄ Amretha's Job Hunt Command Centre loaded!");
</script>
</body>
</html>
